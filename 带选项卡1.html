<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>信用卡管理系统 - 完整版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ================ CSS模块：基础样式 ================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            font-size: 14px;
            overflow-x: hidden;
            height: 100%;
        }
        
        body.modal-open {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            touch-action: none;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* ================ CSS模块：头部样式 ================ */
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px 0;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            text-align: center;
            position: relative;
        }
        
        .header-actions {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        
        h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .subtitle {
            font-size: 16px;
            opacity: 0.9;
        }
        
        /* ================ CSS模块：主选项卡样式 ================ */
        .main-tabs {
            display: flex;
            background-color: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }
        
        .main-tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            font-size: 16px;
        }
        
        .main-tab:hover {
            background-color: #f8f9fa;
        }
        
        .main-tab.active {
            background-color: #f0f7ff;
            color: var(--secondary-color);
            border-bottom-color: var(--secondary-color);
        }
        
        .main-content {
            display: none;
        }
        
        .main-content.active {
            display: block;
        }
        
        /* ================ CSS模块：仪表盘样式 ================ */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .dashboard-card {
            background-color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        
        .dashboard-card h3 {
            font-size: 16px;
            color: #7f8c8d;
            margin-bottom: 10px;
        }
        
        .dashboard-card .value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .dashboard-card .value.total-limit {
            color: var(--secondary-color);
        }
        
        .dashboard-card .value.total-used {
            color: var(--accent-color);
        }
        
        .dashboard-card .value.total-remaining {
            color: var(--success-color);
        }
        
        /* ================ CSS模块：卡片和按钮样式 ================ */
        .card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .card-header h2 {
            font-size: 22px;
            color: var(--primary-color);
        }
        
        /* 按钮基础样式 */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #219653;
        }
        
        .btn-danger {
            background-color: var(--accent-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .btn-info {
            background-color: #17a2b8;
            color: white;
        }
        
        .btn-info:hover {
            background-color: #138496;
        }
        
        .btn-sm {
            padding: 8px 12px;
            font-size: 12px;
        }
        
        .undo-btn {
            background-color: var(--warning-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .undo-btn:hover {
            background-color: #e67e22;
        }
        
        .undo-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .reset-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .reset-btn:hover {
            background-color: #c0392b;
        }
        
        /* ================ CSS模块：表单样式 ================ */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        /* 表单元素通用样式 */
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: border 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--secondary-color);
            outline: none;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
        }
        
        .empty-state i {
            font-size: 50px;
            color: #ddd;
            margin-bottom: 15px;
        }
        
        /* ================ CSS模块：信用卡卡片样式 ================ */
        .card-items-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .card-item {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: var(--border-radius);
            padding: 20px;
            border-left: 5px solid var(--secondary-color);
        }
        
        .card-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .card-bank {
            font-weight: 600;
            font-size: 18px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* 银行账单日徽章样式 - 优化：防止换行 */
        .bank-bill-day-badge {
            background-color: #e3f2fd;
            color: var(--secondary-color);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: 6px;
            border: 1px solid rgba(52, 152, 219, 0.3);
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .bank-bill-day-badge i {
            font-size: 10px;
        }
        
        .card-number {
            color: #7f8c8d;
            font-family: monospace;
            letter-spacing: 1px;
            margin-top: 5px;
        }
        
        .bank-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #eee;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: var(--secondary-color);
        }
        
        .card-details-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .total-limit-section {
            background-color: white;
            padding: 15px;
            border-radius: var(--border-radius);
            text-align: center;
        }
        
        .total-limit-label {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .total-limit-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--secondary-color);
        }
        
        .used-remaining-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .limit-item {
            text-align: center;
            padding: 10px;
            background-color: white;
            border-radius: var(--border-radius);
        }
        
        .limit-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .limit-value {
            font-size: 18px;
            font-weight: 600;
        }
        
        .limit-used {
            color: var(--accent-color);
        }
        
        .limit-remaining {
            color: var(--success-color);
        }
        
        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-success {
            background-color: #d5f4e6;
            color: var(--success-color);
        }
        
        .badge-warning {
            background-color: #fef5e7;
            color: var(--warning-color);
        }
        
        .badge-danger {
            background-color: #fdedec;
            color: var(--accent-color);
        }
        
        /* 操作按钮样式 - 优化：手机端水平显示 */
        .actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        /* ================ CSS模块：模态框样式 ================ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: 20px;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            width: 90%;
            max-width: 800px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background-color: white;
            z-index: 1;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        /* ================ CSS模块：通知和提示样式 ================ */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background-color: var(--success-color);
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 1001;
            display: none;
            align-items: center;
            gap: 10px;
            min-width: 300px;
        }
        
        .toast.active {
            display: flex;
            animation: slideIn 0.3s ease;
        }
        
        .toast.error {
            background-color: var(--accent-color);
        }
        
        .toast.info {
            background-color: var(--secondary-color);
        }
        
        .toast.warning {
            background-color: var(--warning-color);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        footer {
            text-align: center;
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            color: #7f8c8d;
            font-size: 14px;
        }
        
        /* ================ CSS模块：交易管理页面特定样式 ================ */
        .extra-fee-info {
            background-color: #f9f7ff;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            border-left: 4px solid #6c5ce7;
        }
        
        .extra-fee-formula {
            background-color: white;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 10px;
            font-family: monospace;
        }
        
        .extra-fee-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .extra-fee-item {
            background-color: white;
            padding: 15px;
            border-radius: var(--border-radius);
            text-align: center;
            border: 1px solid #ddd;
        }
        
        .extra-fee-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .extra-fee-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .fee-breakdown {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: var(--border-radius);
            margin-top: 10px;
            font-size: 12px;
        }
        
        .extra-fee-toggle {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            color: #555;
            padding: 8px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            margin-top: 10px;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .extra-fee-options {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid #ddd;
        }
        
        .extra-fee-options.active {
            display: block;
        }
        
        .amount-input-hint {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .transaction-tabs {
            display: flex;
            background-color: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }
        
        .transaction-tab {
            flex: 1;
            padding: 12px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            border-bottom: 3px solid transparent;
        }
        
        .transaction-tab:hover {
            background-color: #f8f9fa;
        }
        
        .transaction-tab.active {
            background-color: #f0f7ff;
            color: var(--secondary-color);
            border-bottom-color: var(--secondary-color);
        }
        
        .transaction-content {
            display: none;
        }
        
        .transaction-content.active {
            display: block;
        }
        
        .transactions-table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        
        .transactions-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            min-width: 1200px;
        }
        
        .transactions-table thead {
            background-color: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .transactions-table th {
            padding: 16px 8px;
            text-align: center;
            font-weight: 600;
            color: var(--primary-color);
            border-bottom: 2px solid #eee;
            white-space: nowrap;
            font-size: 14px;
            width: 110px;
        }
        
        .transactions-table td {
            padding: 14px 8px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
            white-space: nowrap;
            font-size: 14px;
            text-align: center;
            width: 110px;
        }
        
        .transactions-table .actions-cell {
            white-space: nowrap;
            text-align: center;
            width: 140px;
        }
        
        .transactions-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        
        .action-btn {
            padding: 8px 10px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }
        
        .action-btn-edit {
            background-color: #e3f2fd;
            color: var(--secondary-color);
        }
        
        .action-btn-edit:hover {
            background-color: #bbdefb;
        }
        
        .action-btn-delete {
            background-color: #ffebee;
            color: var(--accent-color);
        }
        
        .action-btn-delete:hover {
            background-color: #ffcdd2;
        }
        
        .bill-link {
            color: var(--secondary-color);
            cursor: pointer;
            text-decoration: underline;
        }
        
        .bill-link:hover {
            color: #2980b9;
        }
        
        .no-bill {
            color: #7f8c8d;
            font-style: italic;
        }
        
        /* ================ CSS模块：账单管理页面特定样式 ================ */
        .year-filter-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
        }
        
        .year-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .year-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 18px;
            color: var(--primary-color);
        }
        
        .year-arrow {
            background: none;
            border: none;
            font-size: 16px;
            color: var(--secondary-color);
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .year-arrow:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }
        
        .year-arrow:disabled {
            color: #ccc;
            cursor: not-allowed;
        }
        
        .month-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .month-grid-btn {
            padding: 12px 8px;
            background-color: white;
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius);
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 70px;
            position: relative;
            overflow: hidden;
        }
        
        .month-grid-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        
        .month-grid-btn.active {
            background-color: rgba(39, 174, 96, 0.15);
            border-color: var(--success-color);
            color: var(--success-color);
            border-width: 3px;
            transform: scale(1.05);
        }
        
        .month-grid-btn.has-bill {
            background-color: rgba(52, 152, 219, 0.05);
            border-color: var(--secondary-color);
            color: var(--secondary-color);
        }
        
        .month-grid-btn.active::after {
            content: '';
            position: absolute;
            top: 6px;
            right: 6px;
            width: 10px;
            height: 10px;
            background-color: var(--success-color);
            border-radius: 50%;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.8);
        }
        
        .month-grid-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 3px;
        }
        
        .month-grid-amount {
            font-size: 13px;
            color: #2c3e50;
            font-weight: 500;
        }
        
        .month-grid-count {
            font-size: 11px;
            color: #7f8c8d;
            margin-top: 2px;
        }
        
        .bill-cards-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        .bill-card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            padding: 15px;
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        }
        
        .bill-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.12);
        }
        
        .bill-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .bill-card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .bill-card-bank-icon {
            color: var(--secondary-color);
            font-size: 18px;
        }
        
        .bill-card-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .status-unpaid {
            background-color: #fef5e7;
            color: var(--warning-color);
        }
        
        .status-paid {
            background-color: #d5f4e6;
            color: var(--success-color);
        }
        
        .bill-card-body {
            margin-bottom: 15px;
        }
        
        .bill-card-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .bill-card-label {
            color: #7f8c8d;
            font-size: 13px;
        }
        
        .bill-card-value {
            font-weight: 600;
            color: #2c3e50;
            font-size: 15px;
        }
        
        .bill-card-value.large {
            font-size: 18px;
            color: var(--accent-color);
        }
        
        /* ================ CSS模块：账单详情样式 ================ */
        .bill-detail-info {
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid var(--secondary-color);
        }
        
        .bill-detail-summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .bill-detail-item {
            background-color: white;
            padding: 12px;
            border-radius: var(--border-radius);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .bill-detail-item-label {
            font-size: 11px;
            color: #7f8c8d;
            margin-bottom: 3px;
        }
        
        .bill-detail-item-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .bill-detail-item-value.amount {
            font-size: 20px;
            color: var(--accent-color);
        }
        
        .bill-transaction-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .bill-transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background-color: white;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--success-color);
        }
        
        .bill-transaction-date {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 13px;
            min-width: 80px;
        }
        
        .bill-transaction-description {
            flex: 1;
            margin: 0 10px;
            color: #555;
            font-size: 13px;
        }
        
        .bill-transaction-amount {
            font-weight: 600;
            color: var(--accent-color);
            font-size: 14px;
            min-width: 70px;
            text-align: right;
        }
        
        /* ================ CSS模块：分期相关样式 ================ */
        .installment-record {
            background-color: #f0fff8;
            border-left: 4px solid #27ae60;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 15px;
            margin-bottom: 15px;
        }
        
        .installment-record h4 {
            color: var(--primary-color);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .installment-record-detail {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .installment-record-item {
            background-color: white;
            padding: 10px;
            border-radius: var(--border-radius);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .installment-record-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 3px;
        }
        
        .installment-record-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .installment-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        
        .installment-status-pending {
            background-color: #fef5e7;
            color: var(--warning-color);
        }
        
        .installment-status-paid {
            background-color: #d5f4e6;
            color: var(--success-color);
        }
        
        .installment-status-current {
            background-color: #e3f4f7;
            color: var(--secondary-color);
        }
        
        .installment-plan {
            background-color: white;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 10px;
            border: 1px solid #ddd;
        }
        
        .installment-phase {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            border-left: 3px solid var(--secondary-color);
        }
        
        .installment-phase-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .installment-detail-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 14px;
        }
        
        .installment-detail-toggle {
            background-color: #f0f7ff;
            border: 1px solid var(--secondary-color);
            color: var(--secondary-color);
            padding: 8px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            margin-top: 10px;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .installment-detail-toggle:hover {
            background-color: #e1f0ff;
        }
        
        .installment-detail-content {
            display: none;
            margin-top: 15px;
        }
        
        .installment-detail-content.active {
            display: block;
        }
        
        .installment-apr {
            background-color: #fff9e6;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 15px;
            font-size: 14px;
        }
        
        .installment-apr-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .installment-apr-detail {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .installment-apr-item {
            background-color: white;
            padding: 12px;
            border-radius: var(--border-radius);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .installment-apr-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .installment-apr-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .installment-apr-value.highlight {
            color: var(--accent-color);
            font-size: 20px;
        }
        
        .installment-apr-note {
            font-size: 13px;
            color: #666;
            margin-top: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: var(--border-radius);
            border-left: 3px solid #ddd;
        }
        
        /* ================ CSS模块：还款相关样式 ================ */
        .repayment-detail {
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #3498db;
        }
        
        .repayment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: white;
            border-radius: var(--border-radius);
            margin-bottom: 8px;
            border-left: 3px solid #3498db;
        }
        
        .repayment-item.installment {
            border-left-color: #27ae60;
        }
        
        .repayment-item.new-consumption {
            border-left-color: #f39c12;
        }
        
        .repayment-item-label {
            font-weight: 500;
            color: #2c3e50;
        }
        
        .repayment-item-amount {
            font-weight: 600;
            color: var(--accent-color);
        }
        
        .repayment-priority-note {
            background-color: #fff9e6;
            border-left: 4px solid #f39c12;
            padding: 10px;
            border-radius: var(--border-radius);
            margin-top: 10px;
            font-size: 13px;
            color: #666;
        }
        
        /* ================ CSS模块：原始分期详情样式 ================ */
        .original-installment-detail {
            background-color: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 15px;
            margin-bottom: 15px;
        }
        
        .original-installment-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .original-installment-item {
            background-color: white;
            padding: 12px;
            border-radius: var(--border-radius);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .original-installment-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .original-installment-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .original-installment-status {
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            display: inline-block;
        }
        
        .original-installment-toggle {
            background-color: #f0f7ff;
            border: 1px solid var(--secondary-color);
            color: var(--secondary-color);
            padding: 8px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .original-installment-toggle:hover {
            background-color: #e1f0ff;
        }
        
        /* ================ CSS模块：杂项样式 ================ */
        .amount-label-box {
            display: inline-block;
            background-color: #f0f7ff;
            border: 1px solid #3498db;
            border-radius: 12px;
            padding: 4px 10px;
            margin-left: 8px;
            font-size: 12px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .section-toggle-btn {
            background-color: #f0f7ff;
            border: 1px solid var(--secondary-color);
            color: var(--secondary-color);
            padding: 6px 12px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-left: 10px;
        }
        
        .section-toggle-btn:hover {
            background-color: #e1f0ff;
        }
        
        /* 添加表格行悬停效果 */
        .transactions-table tbody tr {
            transition: background-color 0.2s ease;
        }
        
        .transactions-table tbody tr:hover {
            background-color: #f5f9ff;
        }
        
        /* 添加表头固定效果 */
        .transactions-table thead {
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        /* 优化金额列样式 */
        .amount-cell {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .extra-fee-cell {
            font-weight: 600;
            color: #e74c3c;
        }
        
        /* 优化表头样式 */
        .transactions-table th {
            background-color: #f8f9fa;
            color: #2c3e50;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 13px;
            letter-spacing: 0.5px;
        }
        
        /* 描述列内容也居中 */
        .transactions-table td:nth-child(3),
        .transactions-table th:nth-child(3) {
            text-align: center;
        }
        
        /* 添加模态框背景点击保护层 */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
        
        .modal-backdrop.active {
            display: block;
        }
        
        /* 添加表格内容过长时的省略号处理 */
        .transactions-table td {
            overflow: hidden;
            text-overflow: ellipsis;
            max-height: 60px;
            line-height: 1.4;
        }
        
        /* Excel备份恢复按钮样式 */
        .excel-actions {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
        }
        
        /* 进度提示模态框 */
        #progress-modal .modal-content {
            max-width: 420px;
        }
        
        #progress-bar {
            width: 0%;
            height: 12px;
            background: #27ae60;
            transition: width 0.3s ease;
        }
        
        /* 分页样式 */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 15px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        
        .pagination-btn {
            padding: 8px 15px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .pagination-btn:hover:not(:disabled) {
            background-color: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }
        
        .pagination-btn:disabled {
            background-color: #f5f5f5;
            color: #ccc;
            cursor: not-allowed;
        }
        
        .pagination-info {
            font-size: 14px;
            color: #555;
        }
        
        .pagination-page {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .page-input {
            width: 60px;
            text-align: center;
            padding: 5px;
        }
        
        .page-total {
            color: #7f8c8d;
        }
        
        /* 额度输入警告样式 */
        .input-warning {
            border-color: var(--warning-color) !important;
        }
        
        .auto-calc-hint {
            font-size: 12px;
            color: #3498db;
            margin-top: 5px;
            font-style: italic;
        }
        
        /* ================ CSS模块：响应式设计 ================ */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .card-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .header-actions {
                position: static;
                margin-top: 10px;
                flex-direction: column;
            }
            
            .undo-btn, .reset-btn {
                width: 100%;
                justify-content: center;
            }
            
            .excel-actions {
                position: static;
                margin-top: 10px;
                flex-direction: column;
            }
            
            .transactions-table-container {
                font-size: 12px;
                overflow-x: scroll;
            }
            
            .transactions-table th,
            .transactions-table td {
                padding: 10px 5px;
                font-size: 12px;
            }
            
            .action-buttons {
                flex-direction: row;
                gap: 3px;
            }
            
            .transaction-tabs {
                flex-direction: column;
            }
            
            .main-tabs {
                flex-direction: column;
            }
            
            .btn-sm {
                padding: 6px 8px;
                font-size: 11px;
            }
            
            .extra-fee-details {
                grid-template-columns: 1fr;
            }
            
            .month-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .bill-cards-container {
                grid-template-columns: 1fr;
            }
            
            .bill-detail-summary {
                grid-template-columns: 1fr;
            }
            
            .installment-record-detail {
                grid-template-columns: 1fr;
            }
            
            .installment-apr-detail {
                grid-template-columns: 1fr;
            }
            
            .original-installment-summary {
                grid-template-columns: 1fr;
            }
            
            .transactions-table th:nth-child(1),
            .transactions-table td:nth-child(1),
            .transactions-table th:nth-child(2),
            .transactions-table td:nth-child(2),
            .transactions-table th:nth-child(3),
            .transactions-table td:nth-child(3),
            .transactions-table th:nth-child(4),
            .transactions-table td:nth-child(4),
            .transactions-table th:nth-child(5),
            .transactions-table td:nth-child(5),
            .transactions-table th:nth-child(6),
            .transactions-table td:nth-child(6),
            .transactions-table th:nth-child(7),
            .transactions-table td:nth-child(7),
            .transactions-table th:nth-child(8),
            .transactions-table td:nth-child(8) {
                width: 90px;
                min-width: 90px;
                max-width: 90px;
            }
            
            .transactions-table th:nth-child(9),
            .transactions-table td:nth-child(9) {
                width: 100px;
                min-width: 100px;
                max-width: 100px;
                text-align: center;
            }
            
            .action-btn {
                width: 30px;
                height: 30px;
                padding: 5px;
            }
            
            /* 移动端模态框优化 */
            .modal {
                padding: 10px;
            }
            
            .modal-content {
                width: 95%;
                max-height: 95vh;
            }
            
            /* 移动端账单卡片按钮优化：两行显示，一行两个 */
            .bill-card .form-row {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .bill-card .form-row .btn {
                flex: 1 0 calc(50% - 4px);
                min-width: 0;
                padding: 8px 5px;
                font-size: 12px;
                justify-content: center;
            }
            
            /* 分页响应式 */
            .pagination {
                flex-wrap: wrap;
                gap: 8px;
                padding: 10px;
            }
            
            .pagination-btn {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .pagination-info {
                order: 3;
                width: 100%;
                text-align: center;
                margin-top: 10px;
            }
            
            /* 防止移动端输入框获取焦点时页面缩放 */
            input, select, textarea {
                font-size: 16px;
            }
            
            /* 移动端：仪表盘卡片单列显示 */
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            /* 移动端：信用卡卡片单列显示 */
            .card-items-container {
                grid-template-columns: 1fr;
            }
            
            /* 移动端：操作按钮横排三个显示 - 保持水平排列 */
            .actions {
                flex-direction: row;
                flex-wrap: nowrap;
                gap: 6px;
                justify-content: space-between;
                width: 100%;
            }
            
            .actions button {
                flex: 1;
                min-width: 0;
                padding: 10px 6px;
                font-size: 12px;
                white-space: nowrap;
                overflow: hidden;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            /* 小屏幕：只显示图标，隐藏文字 */
            @media (max-width: 480px) {
                .actions button span {
                    display: none;
                }
                
                .actions button i {
                    margin: 0;
                    font-size: 14px;
                }
                
                .actions button {
                    padding: 8px 4px;
                }
                
                .dashboard-card {
                    padding: 15px;
                }
                
                .dashboard-card .value {
                    font-size: 24px;
                }
                
                .card-header h2 {
                    font-size: 18px;
                }
                
                /* 移动端：银行账单日徽章样式调整 */
                .bank-bill-day-badge {
                    font-size: 10px;
                    padding: 2px 6px;
                    margin-left: 5px;
                }
            }
            
            /* 中等屏幕：显示图标+文字 */
            @media (min-width: 481px) {
                .actions button span {
                    display: inline;
                    margin-left: 4px;
                }
                
                .actions button i {
                    font-size: 12px;
                }
            }
        }
        
        @media (min-width: 768px) {
            .modal-content {
                max-width: 600px;
            }
            
            .month-grid {
                grid-template-columns: repeat(6, 1fr);
                gap: 10px;
            }
            
            .month-grid-btn {
                min-height: 80px;
                padding: 15px 10px;
            }
            
            .month-grid-name {
                font-size: 15px;
            }
            
            .bill-cards-container {
                grid-template-columns: repeat(2, 1fr);
            }
            
            /* 电脑端：一行显示两个卡片 */
            .card-items-container {
                grid-template-columns: repeat(2, 1fr);
            }
            
            /* 电脑端：操作按钮横向排列，不再是垂直排列 */
            .actions {
                flex-direction: row;
                justify-content: space-between;
                gap: 8px;
            }
            
            .actions button {
                flex: 1;
                min-width: 0;
            }
            
            /* 账单管理页面卡片内的按钮也横向排列 */
            .bill-card .form-row {
                flex-direction: row;
            }
            
            .bill-card .form-row .btn {
                flex: 1;
                min-width: 0;
            }
        }
        
        @media (min-width: 1200px) {
            .card-items-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-credit-card"></i> 信用卡管理系统</h1>
            <p class="subtitle">完整版 - 仪表盘、交易管理与账单管理一体化</p>
            
            <!-- Excel备份/恢复按钮 -->
            <div class="excel-actions">
                <button class="btn btn-success btn-sm" id="backup-btn">
                    <i class="fas fa-file-excel"></i> 备份Excel
                </button>
                <label class="btn btn-info btn-sm" for="restore-input" style="cursor:pointer;">
                    <i class="fas fa-upload"></i> 恢复Excel
                </label>
                <input type="file" id="restore-input" accept=".xlsx,.xls" style="display:none"/>
            </div>
            
            <!-- 撤销和重置按钮 -->
            <div class="header-actions">
                <button class="undo-btn" id="undo-btn" title="撤销上一步操作" disabled>
                    <i class="fas fa-undo"></i> 撤销
                </button>
                <button class="reset-btn" id="reset-data-btn">
                    <i class="fas fa-trash"></i> 重置全部数据
                </button>
            </div>
        </header>
        
        <!-- 主选项卡 -->
        <div class="main-tabs">
            <!-- 修改1：仪表盘设为默认活动选项卡 -->
            <div class="main-tab active" data-main-tab="dashboard">
                <i class="fas fa-tachometer-alt"></i> 仪表盘
            </div>
            <div class="main-tab" data-main-tab="transactions">
                <i class="fas fa-exchange-alt"></i> 交易管理
            </div>
            <div class="main-tab" data-main-tab="bills">
                <i class="fas fa-file-invoice-dollar"></i> 账单管理
            </div>
        </div>
        
        <!-- 仪表盘页面内容 -->
        <!-- 修改2：仪表盘内容设为默认活动内容 -->
        <div class="main-content active" id="dashboard-content">
            <!-- 仪表板 - 移除了卡片总数卡片 -->
            <div class="dashboard-cards">
                <div class="dashboard-card">
                    <h3><i class="fas fa-wallet"></i> 总额度</h3>
                    <div class="value total-limit" id="total-limit">¥0</div>
                </div>
                <div class="dashboard-card">
                    <h3><i class="fas fa-money-bill-wave"></i> 已使用额度</h3>
                    <div class="value total-used" id="total-used">¥0</div>
                </div>
                <div class="dashboard-card">
                    <h3><i class="fas fa-piggy-bank"></i> 剩余额度</h3>
                    <div class="value total-remaining" id="total-remaining">¥0</div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-credit-card"></i> 我的信用卡 (<span id="cards-count">0</span>张)</h2>
                    <button class="btn btn-primary" id="add-card-btn">
                        <i class="fas fa-plus"></i> 添加信用卡
                    </button>
                </div>
                <div class="card-items-container" id="cards-list">
                    <!-- 卡片将由JavaScript动态渲染 -->
                </div>
            </div>
        </div>
        
        <!-- 交易管理页面内容 -->
        <!-- 修改3：交易管理内容不再默认活动 -->
        <div class="main-content" id="transactions-content">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-exchange-alt"></i> 交易管理</h2>
                    <button class="btn btn-primary" id="add-transaction-btn">
                        <i class="fas fa-plus"></i> 添加交易
                    </button>
                </div>
                
                <!-- 个人额外费用说明 -->
                <div class="extra-fee-info">
                    <h3><i class="fas fa-calculator"></i> 个人额外费用说明</h3>
                    <p>你可以为每笔交易添加个人额外费用，计算公式为：</p>
                    <div class="extra-fee-formula">
                        <strong>额外总费用 = 消费金额 × 额外费率 + 额外固定费</strong>
                    </div>
                    <p>默认额外费率：0.6% (0.006)，支持自定义</p>
                    
                    <div class="extra-fee-details">
                        <div class="extra-fee-item">
                            <div class="extra-fee-label">当前额外费率</div>
                            <div class="extra-fee-value" id="current-extra-rate">0.6%</div>
                        </div>
                        <div class="extra-fee-item">
                            <div class="extra-fee-label">当前固定费</div>
                            <div class="extra-fee-value" id="current-extra-fixed">¥0</div>
                        </div>
                        <div class="extra-fee-item">
                            <div class="extra-fee-label">额外总费用</div>
                            <div class="extra-fee-value" id="total-extra-fee">¥0</div>
                        </div>
                    </div>
                </div>
                
                <!-- 交易管理选项卡 -->
                <div class="transaction-tabs">
                    <div class="transaction-tab active" data-transaction-tab="all">
                        <i class="fas fa-list"></i> 全部交易
                    </div>
                    <div class="transaction-tab" data-transaction-tab="current">
                        <i class="fas fa-calendar-week"></i> 本期账单
                    </div>
                    <div class="transaction-tab" data-transaction-tab="next">
                        <i class="fas fa-calendar-alt"></i> 下期账单
                    </div>
                </div>
                
                <!-- 全部交易 -->
                <div class="transaction-content active" id="all-transactions-content">
                    <div id="all-transactions-list">
                        <div class="empty-state">
                            <i class="fas fa-exchange-alt"></i>
                            <h3>暂无交易记录</h3>
                            <p>点击上方按钮添加你的第一笔交易</p>
                        </div>
                    </div>
                    <!-- 分页控件 -->
                    <div class="pagination" id="all-transactions-pagination" style="display: none;">
                        <button class="pagination-btn" id="first-page-btn" title="第一页">
                            <i class="fas fa-angle-double-left"></i>
                        </button>
                        <button class="pagination-btn" id="prev-page-btn" title="上一页">
                            <i class="fas fa-angle-left"></i>
                        </button>
                        <div class="pagination-page">
                            <span>第</span>
                            <input type="number" class="page-input" id="current-page-input" min="1" value="1">
                            <span class="page-total">/ <span id="total-pages">1</span> 页</span>
                        </div>
                        <button class="pagination-btn" id="next-page-btn" title="下一页">
                            <i class="fas fa-angle-right"></i>
                        </button>
                        <button class="pagination-btn" id="last-page-btn" title="最后一页">
                            <i class="fas fa-angle-double-right"></i>
                        </button>
                        <div class="pagination-info">
                            共 <span id="total-transactions">0</span> 条记录，每页 20 条
                        </div>
                    </div>
                </div>
                
                <!-- 本期账单交易 -->
                <div class="transaction-content" id="current-transactions-content">
                    <div id="current-transactions-list">
                        <div class="empty-state">
                            <i class="fas fa-calendar-week"></i>
                            <h3>本期账单暂无交易</h3>
                            <p>本期账单中还没有交易记录</p>
                        </div>
                    </div>
                </div>
                
                <!-- 下期账单交易 -->
                <div class="transaction-content" id="next-transactions-content">
                    <div id="next-transactions-list">
                        <div class="empty-state">
                            <i class="fas fa-calendar-alt"></i>
                            <h3>下期账单暂无交易</h3>
                            <p>下期账单中还没有交易记录</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 账单管理页面内容 -->
        <div class="main-content" id="bills-content">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-file-invoice-dollar"></i> 账单管理</h2>
                    <button class="btn btn-primary" id="generate-bills-btn">
                        <i class="fas fa-sync"></i> 重新生成所有账单
                    </button>
                </div>
                
                <!-- 年份筛选器 -->
                <div class="year-filter-section">
                    <div class="year-header">
                        <div class="year-selector">
                            <button class="year-arrow" id="prev-year-btn" title="上一年">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <span id="current-year-display">2024年</span>
                            <button class="year-arrow" id="next-year-btn" title="下一年">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div style="flex: 1;"></div>
                        <button class="btn btn-primary" id="current-month-btn">
                            <i class="fas fa-calendar-day"></i> 本月
                        </button>
                    </div>
                    
                    <!-- 月份按钮网格 -->
                    <div class="month-grid" id="month-grid">
                        <!-- 月份按钮会动态生成 -->
                    </div>
                </div>
                
                <!-- 月份账单卡片显示 -->
                <div id="monthly-bills-container">
                    <div class="empty-state">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <h3>暂无账单记录</h3>
                        <p>请先添加信用卡和交易记录</p>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>信用卡管理系统 - 完整版 &copy; 2024–2026 | 仪表盘、交易管理与账单管理一体化</p>
            <p><small>提示：所有数据存储在本地浏览器中，清除浏览器数据将会删除所有信息</small></p>
            <p style="margin-top: 5px; font-size: 12px; color: #aaa;">版本号：5.0.0 | 最后更新：2026年1月（整合仪表盘、交易管理、账单管理）</p>
        </footer>
    </div>
    
    <!-- 模态框背景保护层 -->
    <div class="modal-backdrop" id="modal-backdrop"></div>
    
    <!-- ================ 所有模态框 ================ -->
    
    <!-- 添加信用卡模态框 -->
    <div class="modal" id="add-card-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-credit-card"></i> 添加信用卡</h2>
                <button class="close-modal" id="close-card-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="add-card-form">
                    <div class="form-group">
                        <label for="card-number">卡号 *</label>
                        <input type="text" id="card-number" placeholder="请输入信用卡号" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="card-bank">银行 *</label>
                        <select id="card-bank" required>
                            <option value="">请选择银行</option>
                            <option value="工商银行">工商银行</option>
                            <option value="中国银行">中国银行</option>
                            <option value="建设银行">建设银行</option>
                            <option value="农业银行">农业银行</option>
                            <option value="邮政银行">邮政银行</option>
                            <option value="交通银行">交通银行</option>
                            <option value="招商银行">招商银行</option>
                            <option value="光大银行">光大银行</option>
                            <option value="民生银行">民生银行</option>
                            <option value="兴业银行">兴业银行</option>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="card-limit">信用额度（元）*</label>
                            <input type="number" id="card-limit" min="0" step="0.01" value="10000" required>
                            <div class="amount-input-hint">支持小数，如10000.50</div>
                            <div class="auto-calc-hint">修改已使用额度或可用额度，另一个会自动计算</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="card-used">已使用额度（元）</label>
                            <input type="number" id="card-used" min="0" step="0.01" value="0">
                            <div class="amount-input-hint">支持小数，修改后自动计算可用额度</div>
                        </div>
                        <div class="form-group">
                            <label for="card-remaining">可用额度（元）</label>
                            <input type="number" id="card-remaining" min="0" step="0.01" value="10000">
                            <div class="amount-input-hint">支持小数，修改后自动计算已使用额度</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="bill-day">账单日（1-28）*</label>
                            <input type="number" id="bill-day" min="1" max="28" value="1" required>
                            <div class="amount-input-hint">每月几号出账单</div>
                        </div>
                        <div class="form-group">
                            <label for="due-days">还款间隔天数（1-60）*</label>
                            <input type="number" id="due-days" min="1" max="60" value="20" required>
                            <div class="amount-input-hint">账单日后多少天还款（如：20天）</div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-check"></i> 添加卡片
                        </button>
                        <button type="button" class="btn btn-danger" id="cancel-card-modal">
                            取消
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 编辑信用卡模态框 -->
    <div class="modal" id="edit-card-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-edit"></i> 编辑信用卡</h2>
                <button class="close-modal" id="close-edit-card-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="edit-card-form">
                    <input type="hidden" id="edit-card-id">
                    
                    <div class="form-group">
                        <label for="edit-card-number">卡号 *</label>
                        <input type="text" id="edit-card-number" placeholder="请输入信用卡号" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-card-bank">银行 *</label>
                        <select id="edit-card-bank" required>
                            <option value="">请选择银行</option>
                            <option value="工商银行">工商银行</option>
                            <option value="中国银行">中国银行</option>
                            <option value="建设银行">建设银行</option>
                            <option value="农业银行">农业银行</option>
                            <option value="邮政银行">邮政银行</option>
                            <option value="交通银行">交通银行</option>
                            <option value="招商银行">招商银行</option>
                            <option value="光大银行">光大银行</option>
                            <option value="民生银行">民生银行</option>
                            <option value="兴业银行">兴业银行</option>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-card-limit">信用额度（元）*</label>
                            <input type="number" id="edit-card-limit" min="0" step="0.01" required>
                            <div class="amount-input-hint">支持小数</div>
                            <div class="auto-calc-hint">修改已使用额度或可用额度，另一个会自动计算</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-card-used">已使用额度（元）</label>
                            <input type="number" id="edit-card-used" min="0" step="0.01">
                            <div class="amount-input-hint">支持小数，修改后自动计算可用额度</div>
                        </div>
                        <div class="form-group">
                            <label for="edit-card-remaining">可用额度（元）</label>
                            <input type="number" id="edit-card-remaining" min="0" step="0.01">
                            <div class="amount-input-hint">支持小数，修改后自动计算已使用额度</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-bill-day">账单日（1-28）*</label>
                            <input type="number" id="edit-bill-day" min="1" max="28" value="1" required>
                            <div class="amount-input-hint">每月几号出账单</div>
                        </div>
                        <div class="form-group">
                            <label for="edit-due-days">还款间隔天数（1-60）*</label>
                            <input type="number" id="edit-due-days" min="1" max="60" value="20" required>
                            <div class="amount-input-hint">账单日后多少天还款（如：20天）</div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-check"></i> 保存修改
                        </button>
                        <button type="button" class="btn btn-danger" id="cancel-edit-card-modal">
                            取消
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 添加交易模态框（带额外费用设置） -->
    <div class="modal" id="add-transaction-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-exchange-alt"></i> 添加交易</h2>
                <button class="close-modal" id="close-transaction-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="add-transaction-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="transaction-date">日期 *</label>
                            <input type="date" id="transaction-date" required>
                        </div>
                        <div class="form-group">
                            <label for="transaction-card">信用卡 *</label>
                            <select id="transaction-card" required>
                                <option value="">请选择信用卡</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="transaction-amount">消费金额（元）*</label>
                        <input type="number" id="transaction-amount" min="0" step="0.01" placeholder="请输入消费金额" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="transaction-description">交易描述（可选）</label>
                        <input type="text" id="transaction-description" placeholder="例如：餐饮消费、购物等">
                    </div>
                    
                    <!-- 额外费用展开/收起 -->
                    <button type="button" class="extra-fee-toggle" id="toggle-extra-fee">
                        <i class="fas fa-calculator"></i> 显示额外费用设置
                    </button>
                    
                    <!-- 个人额外费用设置 -->
                    <div class="extra-fee-options" id="extra-fee-options">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="transaction-extra-rate">额外费率（%）*</label>
                                <input type="number" id="transaction-extra-rate" min="0" step="0.01" value="0.6" required>
                                <div class="amount-input-hint">默认0.6%，支持自定义</div>
                            </div>
                            <div class="form-group">
                                <label for="transaction-extra-fixed">额外固定费（元）*</label>
                                <input type="number" id="transaction-extra-fixed" min="0" step="0.01" value="0" required>
                                <div class="amount-input-hint">默认0元，支持自定义</div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div class="fee-breakdown">
                                <strong>额外费用计算：</strong>
                                <div id="extra-fee-calculation">消费金额 × 0.6% + 0元 = 0元</div>
                                <div id="extra-fee-annualized" style="margin-top: 5px;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-check"></i> 添加交易
                        </button>
                        <button type="button" class="btn btn-danger" id="cancel-transaction-modal">
                            取消
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 编辑交易模态框 -->
    <div class="modal" id="edit-transaction-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-edit"></i> 编辑交易</h2>
                <button class="close-modal" id="close-edit-transaction-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="edit-transaction-form">
                    <input type="hidden" id="edit-transaction-id">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-transaction-date">日期 *</label>
                            <input type="date" id="edit-transaction-date" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-transaction-card">信用卡 *</label>
                            <select id="edit-transaction-card" required>
                                <option value="">请选择信用卡</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-transaction-amount">消费金额（元）*</label>
                        <input type="number" id="edit-transaction-amount" min="0" step="0.01" placeholder="请输入消费金额" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-transaction-description">交易描述（可选）</label>
                        <input type="text" id="edit-transaction-description" placeholder="例如：餐饮消费、购物等">
                    </div>
                    
                    <!-- 额外费用展开/收起 -->
                    <button type="button" class="extra-fee-toggle" id="toggle-edit-extra-fee">
                        <i class="fas fa-calculator"></i> 显示额外费用设置
                    </button>
                    
                    <!-- 个人额外费用设置 -->
                    <div class="extra-fee-options" id="edit-extra-fee-options">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="edit-transaction-extra-rate">额外费率（%）*</label>
                                <input type="number" id="edit-transaction-extra-rate" min="0" step="0.01" value="0.6" required>
                                <div class="amount-input-hint">默认0.6%，支持自定义</div>
                            </div>
                            <div class="form-group">
                                <label for="edit-transaction-extra-fixed">额外固定费（元）*</label>
                                <input type="number" id="edit-transaction-extra-fixed" min="0" step="0.01" value="0" required>
                                <div class="amount-input-hint">默认0元，支持自定义</div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <div class="fee-breakdown">
                                <strong>额外费用计算：</strong>
                                <div id="edit-extra-fee-calculation">消费金额 × 0.6% + 0元 = 0元</div>
                                <div id="edit-extra-fee-annualized" style="margin-top: 5px;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-check"></i> 保存修改
                        </button>
                        <button type="button" class="btn btn-danger" id="cancel-edit-transaction-modal">
                            取消
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 删除确认模态框（用于信用卡） -->
    <div class="modal" id="delete-confirm-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-exclamation-triangle"></i> 确认删除</h2>
                <button class="close-modal" id="close-delete-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <p id="delete-confirm-message">确定要删除这张信用卡吗？此操作不可撤销。</p>
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-danger" id="confirm-delete-btn">
                        <i class="fas fa-trash"></i> 确认删除
                    </button>
                    <button class="btn btn-info" id="cancel-delete-btn">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 账单详情模态框 -->
    <div class="modal" id="bill-detail-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="bill-detail-title">账单详情</h2>
                <button class="close-modal" id="close-bill-detail-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="bill-detail-content">
                    <!-- 账单详情会动态生成 -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- 还款模态框 (优化为合并还款) -->
    <div class="modal" id="repayment-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="repayment-modal-title">合并还款</h2>
                <button class="close-modal" id="close-repayment-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="repayment-modal-content">
                    <!-- 还款内容会动态生成 -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- 分期模态框 -->
    <div class="modal" id="installment-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-calendar-check"></i> 账单分期</h2>
                <button class="close-modal" id="close-installment-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="installment-modal-content">
                    <!-- 分期内容会动态生成 -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- 重置数据确认模态框 -->
    <div class="modal" id="reset-data-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-exclamation-triangle"></i> 重置全部数据</h2>
                <button class="close-modal" id="close-reset-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div style="background-color: #fef5e7; border-left: 4px solid #f39c12; padding: 12px; margin-bottom: 15px;">
                    <h4><i class="fas fa-exclamation-triangle"></i> 警告：此操作不可恢复！</h4>
                    <p>这将清除所有信用卡、交易记录、账单数据、额外费用设置和撤销历史。</p>
                </div>
                
                <p class="mb-15">确定要重置所有数据吗？</p>
                
                <div class="form-actions">
                    <button class="btn btn-danger" id="confirm-reset-btn">
                        <i class="fas fa-check"></i> 确认重置
                    </button>
                    <button class="btn btn-primary" id="cancel-reset-btn">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 删除交易确认模态框 -->
    <div class="modal" id="delete-transaction-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-trash-alt"></i> 删除交易</h2>
                <button class="close-modal" id="close-delete-transaction-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="delete-transaction-content">
                    <!-- 删除交易内容会动态生成 -->
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-danger" id="confirm-delete-transaction-btn">
                        <i class="fas fa-check"></i> 确认删除
                    </button>
                    <button class="btn btn-primary" id="cancel-delete-transaction-btn">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 进度提示模态框 -->
    <div class="modal" id="progress-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>处理中…</h3>
                <button class="close-modal" onclick="hideModal('progress-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="background:#eee;border-radius:6px;overflow:hidden;">
                    <div id="progress-bar" style="width:0%;height:12px;background:#27ae60;"></div>
                </div>
                <p id="progress-text" style="margin-top:10px;">准备中</p>
            </div>
        </div>
    </div>
    
    <!-- 通知提示 -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toast-message">操作成功！</span>
    </div>
    
    <!-- SheetJS for Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- ================ JavaScript模块：主入口 ================ -->
    <script>
        // 应用状态管理 - 统一管理所有数据
        const state = {
            cards: [],
            transactions: [],
            bills: [],
            installments: [],
            repaymentHistory: [],
            extraFeeSettings: {
                rate: 0.006, // 默认额外费率 0.6%
                fixed: 0 // 默认额外固定费
            },
            undoHistory: [],
            currentTransactionTab: 'all',
            selectedYear: new Date().getFullYear(),
            selectedMonth: new Date().getMonth() + 1,
            currentRepaymentBill: null,
            currentMainTab: 'dashboard', // 修改4：默认主选项卡设为仪表盘
            
            // 分页相关状态
            pagination: {
                currentPage: 1,
                pageSize: 20,
                totalPages: 1,
                totalTransactions: 0
            }
        };
        
        // 活动模态框栈
        let activeModals = [];
        
        // 当前操作状态
        let currentOperation = {
            cardIdToDelete: null,
            cardIdForTransaction: null,
            cardIdForTransactionAdd: null,
            installmentCardId: null,
            installmentYear: null,
            installmentMonth: null
        };
        
        // 渲染标志 - 用于控制何时渲染交易管理页面
        let shouldRenderTransactions = false;
        let shouldRenderDashboard = true; // 修改5：默认渲染仪表盘
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('信用卡管理系统 - 完整版正在初始化...');
            
            try {
                // 加载所有数据
                loadAllData();
                
                // 绑定所有事件
                bindAllEvents();
                
                // 检查是否有默认卡，如果没有则创建（只创建一次）
                checkAndCreateDefaultCard();
                
                // 初始化交易管理页面（但不渲染表格）
                initTransactions();
                
                // 初始化账单管理页面
                initBillsManagement();
                
                // 初始化仪表盘
                initDashboard();
                
                // 更新撤销按钮状态
                updateUndoButton();
                
                // 显示欢迎消息
                setTimeout(() => {
                    showToast('信用卡管理系统已加载完成！', 'success');
                }, 1000);
                
            } catch (error) {
                console.error('初始化错误:', error);
                showToast('初始化失败，请检查控制台', 'error');
            }
        });
    </script>
    
    <!-- ================ JavaScript模块：全局格式化函数 ================ -->
    <script>
        // 全局格式化函数 - 整数显示整数，小数显示2位
        function formatNumber(value, decimals = 2) {
            if (value === null || value === undefined || value === '') return '0';
            
            const num = parseFloat(value);
            if (isNaN(num)) return '0';
            
            // 如果是整数，显示整数，否则保留指定小数位数
            if (Number.isInteger(num)) {
                return num.toString();
            } else {
                return num.toFixed(decimals);
            }
        }
        
        // 格式化金额显示（自动处理小数）
        function formatAmount(amount) {
            return formatNumber(amount, 2);
        }
        
        // 格式化金额带货币符号
        function formatCurrency(amount) {
            return '¥' + formatAmount(amount);
        }
        
        // 格式化百分比显示（保留2位小数）
        function formatPercent(value, decimals = 2) {
            if (value === null || value === undefined || value === '') return '0';
            
            const num = parseFloat(value);
            if (isNaN(num)) return '0';
            
            // 百分比显示固定小数位数
            return num.toFixed(decimals);
        }
        
        // 格式化金额输入框显示
        function formatAmountForInput(amount) {
            if (amount === null || amount === undefined || amount === '') return '';
            
            const num = parseFloat(amount);
            if (isNaN(num)) return '';
            
            // 如果是整数，显示整数，否则保留两位小数
            if (Number.isInteger(num)) {
                return num.toString();
            } else {
                return num.toFixed(2);
            }
        }
        
        // 格式化卡号（隐藏中间部分）
        function formatCardNumber(cardNumber) {
            if (!cardNumber || cardNumber.length <= 4) return cardNumber || '';
            return cardNumber.substring(0, 4) + '****' + cardNumber.substring(cardNumber.length - 4);
        }
        
        // 格式化日期
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            return `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
        }
        
        // 显示通知
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            // 设置消息和样式
            toastMessage.textContent = message;
            
            if (type === 'error') {
                toast.style.backgroundColor = 'var(--accent-color)';
                toast.className = 'toast error active';
                toast.querySelector('i').className = 'fas fa-exclamation-circle';
            } else if (type === 'warning') {
                toast.style.backgroundColor = 'var(--warning-color)';
                toast.className = 'toast active';
                toast.querySelector('i').className = 'fas fa-exclamation-triangle';
            } else if (type === 'info') {
                toast.style.backgroundColor = 'var(--secondary-color)';
                toast.className = 'toast active';
                toast.querySelector('i').className = 'fas fa-info-circle';
            } else {
                toast.style.backgroundColor = 'var(--success-color)';
                toast.className = 'toast active';
                toast.querySelector('i').className = 'fas fa-check-circle';
            }
            
            // 3秒后隐藏
            setTimeout(() => {
                toast.classList.remove('active');
            }, 3000);
        }
        
        // 计算免息期（消费时间到还款日）
        function calculateInterestFreeDays(transactionDate, dueDate) {
            const transDate = new Date(transactionDate);
            const due = new Date(dueDate);
            const timeDiff = due.getTime() - transDate.getTime();
            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
            return daysDiff > 0 ? daysDiff : 0;
        }
        
        // 计算额外费用年化率
        function calculateExtraAnnualizedRate(extraFee, amount, transactionDate, dueDate) {
            if (!transactionDate || !dueDate || amount <= 0) return '0.00';
            
            const interestFreeDays = calculateInterestFreeDays(transactionDate, dueDate);
            if (interestFreeDays <= 0 || (amount - extraFee) <= 0) return '0.00';
            
            const annualizedRate = ((extraFee / (amount - extraFee)) / interestFreeDays * 365 * 100);
            return formatPercent(annualizedRate, 2);
        }
        
        // 格式化数字用于输入框显示
        function formatNumberForInput(num) {
            if (isNaN(num) || num === null || num === undefined) return '';
            
            if (num % 1 === 0) {
                return num.toString();
            } else {
                return parseFloat(num.toFixed(2)).toString();
            }
        }
        
        // 计算还款日（基于账单日和间隔天数）
        function calculateDueDate(billDate, dueDays) {
            const date = new Date(billDate);
            date.setDate(date.getDate() + parseInt(dueDays));
            return date;
        }
    </script>
    
    <!-- ================ JavaScript模块：数据管理 ================ -->
    <script>
        // 检查并创建默认卡（只创建一次）
        function checkAndCreateDefaultCard() {
            if (state.cards.length === 0) {
                // 创建默认卡片 - 工商银行，额度50000，账单日1日，还款间隔20天
                const defaultCard = {
                    id: 'card_default_' + Date.now(),
                    number: '8888',
                    bank: '工商银行',
                    limit: '50000',
                    used: '0',
                    remaining: '50000',
                    billDay: 1,
                    dueDays: 20, // 修复：使用dueDays字段而不是dueDay
                    createdAt: new Date().toISOString()
                };
                
                state.cards.push(defaultCard);
                saveAllData();
                
                console.log('已创建默认工商银行卡（还款间隔20天）');
            }
        }
        
        // 加载所有数据
        function loadAllData() {
            try {
                // 加载卡片数据
                const savedCards = localStorage.getItem('creditCards');
                if (savedCards) {
                    state.cards = JSON.parse(savedCards);
                    // 修复：确保旧数据兼容性，如果卡片有dueDay但没有dueDays，转换一下
                    state.cards.forEach(card => {
                        if (card.dueDay && !card.dueDays) {
                            // 如果旧数据有dueDay，假设间隔是20天（最常见）
                            card.dueDays = 20;
                            delete card.dueDay;
                        }
                        if (!card.dueDays) {
                            card.dueDays = 20; // 默认20天
                        }
                    });
                    console.log(`已加载 ${state.cards.length} 张信用卡`);
                }
                
                // 加载交易数据
                const savedTransactions = localStorage.getItem('creditTransactions');
                if (savedTransactions) {
                    state.transactions = JSON.parse(savedTransactions);
                    console.log(`已加载 ${state.transactions.length} 笔交易记录`);
                }
                
                // 加载账单数据
                const savedBills = localStorage.getItem('creditBills');
                if (savedBills) {
                    state.bills = JSON.parse(savedBills);
                    console.log(`已加载 ${state.bills.length} 个账单记录`);
                }
                
                // 加载分期数据
                const savedInstallments = localStorage.getItem('creditInstallments');
                if (savedInstallments) {
                    state.installments = JSON.parse(savedInstallments);
                    console.log(`已加载 ${state.installments.length} 个分期记录`);
                }
                
                // 加载还款历史
                const savedRepaymentHistory = localStorage.getItem('creditRepaymentHistory');
                if (savedRepaymentHistory) {
                    state.repaymentHistory = JSON.parse(savedRepaymentHistory);
                    console.log(`已加载 ${state.repaymentHistory.length} 条还款记录`);
                }
                
                // 加载额外费用设置
                const savedExtraFeeSettings = localStorage.getItem('creditExtraFeeSettings');
                if (savedExtraFeeSettings) {
                    state.extraFeeSettings = JSON.parse(savedExtraFeeSettings);
                    console.log('已加载额外费用设置');
                }
                
                // 加载撤销历史
                const savedUndoHistory = localStorage.getItem('creditUndoHistory');
                if (savedUndoHistory) {
                    state.undoHistory = JSON.parse(savedUndoHistory);
                    console.log(`已加载 ${state.undoHistory.length} 条撤销历史记录`);
                }
                
                // 确保账单数据有正确的结构
                ensureBillDataStructure();
                
                // 更新分页信息
                updatePaginationInfo();
                
            } catch (error) {
                console.error('加载数据时出错:', error);
                showToast('加载数据时出错', 'error');
            }
        }
        
        // 更新分页信息
        function updatePaginationInfo() {
            state.pagination.totalTransactions = state.transactions.length;
            state.pagination.totalPages = Math.max(1, Math.ceil(state.transactions.length / state.pagination.pageSize));
            
            // 确保当前页不超过总页数
            if (state.pagination.currentPage > state.pagination.totalPages) {
                state.pagination.currentPage = state.pagination.totalPages || 1;
            }
        }
        
        // 修复：确保账单数据结构正确 - 重建账单与交易、分期之间的关系
        function ensureBillDataStructure() {
            // 修复1：确保每个账单都有正确的billId
            state.bills.forEach(bill => {
                if (!bill.billId) {
                    bill.billId = bill.id; // 如果没有billId，使用id
                }
                
                // 确保账单有transactions数组
                if (!bill.transactions) {
                    bill.transactions = [];
                }
                
                // 确保账单有正确的金额字段
                if (bill.amountDue === undefined) {
                    bill.amountDue = bill.totalAmount || 0;
                }
                
                if (bill.paidAmount === undefined) {
                    bill.paidAmount = bill.isPaid ? (bill.totalAmount || 0) : 0;
                }
                
                // 确保分期账单有正确的分期信息
                if (bill.isInstallment && !bill.installmentId && bill.installmentInfo) {
                    bill.installmentId = 'inst_' + Date.now() + Math.random().toString(36).substr(2, 9);
                }
                
                // 修复2：重建账单与卡片的关联
                if (bill.cardId && !bill.bank) {
                    const card = state.cards.find(c => c.id === bill.cardId);
                    if (card) {
                        bill.bank = card.bank;
                        bill.cardNumber = card.number;
                        // 修复：确保账单有dueDays字段
                        if (!bill.dueDays && card.dueDays) {
                            bill.dueDays = card.dueDays;
                        }
                    }
                }
                
                // 修复3：修复分期子账单的originalBillId
                if (bill.installmentPhase && !bill.originalBillId) {
                    // 尝试找到对应的主账单
                    const mainBill = state.bills.find(b => 
                        b.installmentId === bill.installmentId && 
                        !b.installmentPhase
                    );
                    if (mainBill) {
                        bill.originalBillId = mainBill.id;
                    }
                }
                
                // 修复：确保账单有dueDays字段
                if (!bill.dueDays) {
                    const card = state.cards.find(c => c.id === bill.cardId);
                    if (card) {
                        bill.dueDays = card.dueDays || 20;
                    } else {
                        bill.dueDays = 20;
                    }
                }
            });
            
            // 修复4：重建分期计划与账单的关系
            state.installments.forEach(installment => {
                if (!installment.id) {
                    installment.id = 'inst_' + Date.now() + Math.random().toString(36).substr(2, 9);
                }
                
                // 查找对应的主账单
                const mainBill = state.bills.find(bill => 
                    (bill.id === installment.originalBillId || bill.installmentId === installment.id) && 
                    !bill.installmentPhase
                );
                
                if (mainBill) {
                    // 确保主账单有正确的分期信息
                    mainBill.isInstallment = true;
                    mainBill.installmentId = installment.id;
                    mainBill.installmentInfo = mainBill.installmentInfo || {
                        totalAmount: installment.amount || 0,
                        period: installment.period || 0,
                        feeRate: installment.feeRate || 0,
                        monthlyPayment: installment.monthlyPayment || 0,
                        monthlyPrincipal: installment.monthlyPayment || 0,
                        monthlyFee: 0,
                        totalFee: installment.totalFee || 0,
                        totalPayment: installment.totalPayment || 0
                    };
                    
                    // 确保installment有正确的originalBillId
                    if (!installment.originalBillId) {
                        installment.originalBillId = mainBill.id;
                    }
                }
            });
            
            // 修复5：清理无效的分期记录
            state.installments = state.installments.filter(installment => {
                // 保留有对应主账单的分期记录
                return state.bills.some(bill => 
                    bill.installmentId === installment.id || 
                    bill.id === installment.originalBillId
                );
            });
            
            // 修复6：重新计算账单的交易关联
            rebuildBillTransactionRelationships();
            
            console.log('账单数据结构修复完成');
        }
        
        // 修复：重建账单与交易的关系
        function rebuildBillTransactionRelationships() {
            console.log('开始重建账单与交易的关系...');
            
            // 清空所有账单的交易关联
            state.bills.forEach(bill => {
                bill.transactions = [];
                bill.totalAmount = 0;
                bill.amountDue = 0;
            });
            
            // 重新为每笔交易分配账单
            state.transactions.forEach(transaction => {
                const card = state.cards.find(c => c.id === transaction.cardId);
                if (!card) return;
                
                const transDate = new Date(transaction.date);
                const transYear = transDate.getFullYear();
                const transMonth = transDate.getMonth() + 1;
                const transDay = transDate.getDate();
                
                const billDay = card.billDay || 1;
                
                let billYear, billMonth;
                
                // 规则：如果消费日在账单日之后，计入下个月账单
                if (transDay > billDay) {
                    if (transMonth === 12) {
                        billMonth = 1;
                        billYear = transYear + 1;
                    } else {
                        billMonth = transMonth + 1;
                        billYear = transYear;
                    }
                } else {
                    billMonth = transMonth;
                    billYear = transYear;
                }
                
                // 查找或创建账单
                const billId = `bill_${transaction.cardId}_${billYear}_${billMonth}`;
                let bill = state.bills.find(b => b.id === billId);
                
                if (!bill) {
                    // 计算还款日（使用账单日 + dueDays）
                    const billDate = new Date(billYear, billMonth - 1, billDay);
                    const dueDate = calculateDueDate(billDate, card.dueDays || 20);
                    
                    bill = {
                        id: billId,
                        billId: billId,
                        cardId: transaction.cardId,
                        cardNumber: card.number,
                        bank: card.bank,
                        year: billYear,
                        month: billMonth,
                        billDay: billDay,
                        dueDays: card.dueDays || 20, // 修复：使用dueDays字段
                        billDate: billDate.toISOString().split('T')[0],
                        dueDate: dueDate.toISOString().split('T')[0],
                        transactions: [],
                        totalAmount: 0,
                        amountDue: 0,
                        paidAmount: 0,
                        isPaid: false,
                        isInstallment: false,
                        installmentInfo: null,
                        createdAt: new Date().toISOString()
                    };
                    state.bills.push(bill);
                }
                
                // 将交易添加到账单
                if (!bill.transactions.includes(transaction.id)) {
                    bill.transactions.push(transaction.id);
                    bill.totalAmount += parseFloat(transaction.amount);
                    bill.amountDue += parseFloat(transaction.amount);
                }
            });
            
            console.log('账单与交易关系重建完成');
        }
        
        // 保存所有数据
        function saveAllData() {
            try {
                localStorage.setItem('creditCards', JSON.stringify(state.cards));
                localStorage.setItem('creditTransactions', JSON.stringify(state.transactions));
                localStorage.setItem('creditBills', JSON.stringify(state.bills));
                localStorage.setItem('creditInstallments', JSON.stringify(state.installments));
                localStorage.setItem('creditRepaymentHistory', JSON.stringify(state.repaymentHistory));
                localStorage.setItem('creditExtraFeeSettings', JSON.stringify(state.extraFeeSettings));
                localStorage.setItem('creditUndoHistory', JSON.stringify(state.undoHistory));
                console.log('所有数据已保存');
                
                // 更新分页信息
                updatePaginationInfo();
                
                // 如果仪表盘需要渲染，更新仪表盘
                if (shouldRenderDashboard) {
                    renderDashboard();
                }
            } catch (error) {
                console.error('保存数据时出错:', error);
                showToast('保存数据时出错', 'error');
            }
        }
    </script>
    
    <!-- ================ JavaScript模块：模态框管理 ================ -->
    <script>
        // 显示模态框
        function showModal(modalId) {
            // 添加模态框到活动栈
            if (!activeModals.includes(modalId)) {
                activeModals.push(modalId);
            }
            
            // 显示模态框背景保护层
            document.getElementById('modal-backdrop').classList.add('active');
            
            // 显示模态框
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
                document.body.classList.add('modal-open');
                
                // 移动端：防止背景滚动
                document.body.style.overflow = 'hidden';
                document.body.style.position = 'fixed';
                document.body.style.width = '100%';
                document.body.style.height = '100%';
            }
        }
        
        // 隐藏模态框
        function hideModal(modalId) {
            // 从活动栈中移除模态框
            activeModals = activeModals.filter(id => id !== modalId);
            
            // 隐藏模态框
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
            }
            
            // 如果没有任何活动的模态框，恢复页面滚动
            if (activeModals.length === 0) {
                document.getElementById('modal-backdrop').classList.remove('active');
                document.body.classList.remove('modal-open');
                
                // 移动端：恢复背景滚动
                document.body.style.overflow = '';
                document.body.style.position = '';
                document.body.style.width = '';
                document.body.style.height = '';
            }
        }
        
        // 关闭所有模态框
        function closeAllModals() {
            // 关闭所有活动的模态框
            activeModals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('active');
                }
            });
            
            // 清空活动栈
            activeModals = [];
            
            // 隐藏模态框背景保护层
            document.getElementById('modal-backdrop').classList.remove('active');
            
            // 恢复页面滚动
            document.body.classList.remove('modal-open');
            
            // 移动端：恢复背景滚动
                document.body.style.overflow = '';
                document.body.style.position = '';
                document.body.style.width = '';
                document.body.style.height = '';
        }
    </script>
    
    <!-- ================ JavaScript模块：事件绑定 ================ -->
    <script>
        // 绑定所有事件
        function bindAllEvents() {
            // 绑定主选项卡切换事件
            document.querySelectorAll('.main-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-main-tab');
                    switchMainTab(tabId);
                });
            });
            
            // 绑定交易管理选项卡切换事件
            document.querySelectorAll('.transaction-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-transaction-tab');
                    switchTransactionTab(tabId);
                });
            });
            
            // 绑定添加信用卡按钮事件
            document.getElementById('add-card-btn').addEventListener('click', showAddCardModal);
            
            // 绑定添加交易按钮事件
            document.getElementById('add-transaction-btn').addEventListener('click', showAddTransactionModal);
            
            // 绑定模态框关闭事件
            document.getElementById('close-card-modal').addEventListener('click', hideAddCardModal);
            document.getElementById('cancel-card-modal').addEventListener('click', hideAddCardModal);
            
            document.getElementById('close-edit-card-modal').addEventListener('click', hideEditCardModal);
            document.getElementById('cancel-edit-card-modal').addEventListener('click', hideEditCardModal);
            
            document.getElementById('close-transaction-modal').addEventListener('click', hideAddTransactionModal);
            document.getElementById('cancel-transaction-modal').addEventListener('click', hideAddTransactionModal);
            
            document.getElementById('close-edit-transaction-modal').addEventListener('click', hideEditTransactionModal);
document.getElementById('cancel-edit-transaction-modal').addEventListener('click', hideEditTransactionModal);

// ================ 新增：分期和还款模态框关闭事件绑定 ================
document.getElementById('close-installment-modal').addEventListener('click', hideInstallmentModal);
document.getElementById('close-repayment-modal').addEventListener('click', hideRepaymentModal);
document.getElementById('close-bill-detail-modal').addEventListener('click', hideBillDetailModal);

// 绑定删除确认事件
            
            // 绑定删除确认事件
            document.getElementById('confirm-delete-btn').addEventListener('click', confirmDeleteCard);
            document.getElementById('close-delete-modal').addEventListener('click', hideDeleteConfirmModal);
            document.getElementById('cancel-delete-btn').addEventListener('click', hideDeleteConfirmModal);
            
            // 绑定表单提交事件
            document.getElementById('add-card-form').addEventListener('submit', addCard);
            document.getElementById('edit-card-form').addEventListener('submit', updateCard);
            document.getElementById('add-transaction-form').addEventListener('submit', addTransaction);
            document.getElementById('edit-transaction-form').addEventListener('submit', editTransactionSubmit);
            
            // 设置交易日期默认为今天
            document.getElementById('transaction-date').valueAsDate = new Date();
            document.getElementById('edit-transaction-date').valueAsDate = new Date();
            
            // 绑定生成账单按钮事件
            document.getElementById('generate-bills-btn').addEventListener('click', regenerateAllBills);
            
            // 绑定账单管理事件
            document.getElementById('prev-year-btn').addEventListener('click', function() {
                state.selectedYear--;
                updateYearDisplay();
                renderMonthGrid();
                renderMonthBillsCards();
            });
            
            document.getElementById('next-year-btn').addEventListener('click', function() {
                state.selectedYear++;
                updateYearDisplay();
                renderMonthGrid();
                renderMonthBillsCards();
            });
            
            document.getElementById('current-month-btn').addEventListener('click', function() {
                const now = new Date();
                state.selectedYear = now.getFullYear();
                state.selectedMonth = now.getMonth() + 1;
                updateYearDisplay();
                renderMonthGrid();
                renderMonthBillsCards();
                showToast(`已跳转到${state.selectedYear}年${state.selectedMonth}月`, 'info');
            });
            
            // 绑定撤销按钮事件
            document.getElementById('undo-btn').addEventListener('click', undoLastOperation);
            
            // 绑定重置数据按钮事件
            document.getElementById('reset-data-btn').addEventListener('click', showResetModal);
            document.getElementById('confirm-reset-btn').addEventListener('click', confirmResetData);
            document.getElementById('cancel-reset-btn').addEventListener('click', hideResetModal);
            document.getElementById('close-reset-modal').addEventListener('click', hideResetModal);
            
            // 绑定删除交易确认事件
            document.getElementById('confirm-delete-transaction-btn').addEventListener('click', confirmDeleteTransaction);
            
            // 绑定删除交易模态框关闭事件
            document.getElementById('close-delete-transaction-modal').addEventListener('click', hideDeleteTransactionModal);
            document.getElementById('cancel-delete-transaction-btn').addEventListener('click', hideDeleteTransactionModal);
            
            // 绑定账单详情模态框关闭事件
            document.getElementById('close-bill-detail-modal').addEventListener('click', hideBillDetailModal);
            
            // 绑定额外费用计算事件
            document.getElementById('transaction-amount').addEventListener('input', calculateExtraFee);
            document.getElementById('transaction-extra-rate').addEventListener('input', calculateExtraFee);
            document.getElementById('transaction-extra-fixed').addEventListener('input', calculateExtraFee);
            
            document.getElementById('edit-transaction-amount').addEventListener('input', calculateEditExtraFee);
            document.getElementById('edit-transaction-extra-rate').addEventListener('input', calculateEditExtraFee);
            document.getElementById('edit-transaction-extra-fixed').addEventListener('input', calculateEditExtraFee);
            
            // 绑定额外费用展开/收起事件
            document.getElementById('toggle-extra-fee').addEventListener('click', function() {
                const extraFeeOptions = document.getElementById('extra-fee-options');
                const icon = this.querySelector('i');
                
                if (extraFeeOptions.classList.contains('active')) {
                    extraFeeOptions.classList.remove('active');
                    icon.className = 'fas fa-calculator';
                    this.innerHTML = '<i class="fas fa-calculator"></i> 显示额外费用设置';
                } else {
                    extraFeeOptions.classList.add('active');
                    icon.className = 'fas fa-calculator';
                    this.innerHTML = '<i class="fas fa-calculator"></i> 隐藏额外费用设置';
                }
            });
            
            document.getElementById('toggle-edit-extra-fee').addEventListener('click', function() {
                const extraFeeOptions = document.getElementById('edit-extra-fee-options');
                const icon = this.querySelector('i');
                
                if (extraFeeOptions.classList.contains('active')) {
                    extraFeeOptions.classList.remove('active');
                    icon.className = 'fas fa-calculator';
                    this.innerHTML = '<i class="fas fa-calculator"></i> 显示额外费用设置';
                } else {
                    extraFeeOptions.classList.add('active');
                    icon.className = 'fas fa-calculator';
                    this.innerHTML = '<i class="fas fa-calculator"></i> 隐藏额外费用设置';
                }
            });
            
            // 绑定分页事件
            bindPaginationEvents();
            
            // 绑定额度自动计算事件 - 优化后的双向联动
            bindAutoCalculateEvents();
            
            // 添加ESC键关闭模态框功能
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape' || event.keyCode === 27) {
                    closeAllModals();
                }
                // Ctrl+Z 撤销
                if ((event.ctrlKey || event.metaKey) && event.key === 'z') {
                    event.preventDefault();
                    undoLastOperation();
                }
            });
            
            // 绑定模态框背景点击事件
            document.getElementById('modal-backdrop').addEventListener('click', function() {
                closeAllModals();
            });
            
            // 防止模态框内容点击事件冒泡到背景
            document.querySelectorAll('.modal-content').forEach(content => {
                content.addEventListener('click', function(event) {
                    event.stopPropagation();
                });
            });
            
            // 绑定Excel备份恢复事件
            document.getElementById('backup-btn').addEventListener('click', exportExcel);
            document.getElementById('restore-input').addEventListener('change', function(e){
                if (e.target.files && e.target.files[0]) restoreExcel(e.target.files[0]);
                e.target.value = '';
            });
        }
        
        // 绑定分页事件
        function bindPaginationEvents() {
            document.getElementById('first-page-btn')?.addEventListener('click', function() {
                if (state.pagination.currentPage > 1) {
                    state.pagination.currentPage = 1;
                    renderAllTransactions();
                    updatePaginationControls();
                }
            });
            
            document.getElementById('prev-page-btn')?.addEventListener('click', function() {
                if (state.pagination.currentPage > 1) {
                    state.pagination.currentPage--;
                    renderAllTransactions();
                    updatePaginationControls();
                }
            });
            
            document.getElementById('next-page-btn')?.addEventListener('click', function() {
                if (state.pagination.currentPage < state.pagination.totalPages) {
                    state.pagination.currentPage++;
                    renderAllTransactions();
                    updatePaginationControls();
                }
            });
            
            document.getElementById('last-page-btn')?.addEventListener('click', function() {
                if (state.pagination.currentPage < state.pagination.totalPages) {
                    state.pagination.currentPage = state.pagination.totalPages;
                    renderAllTransactions();
                    updatePaginationControls();
                }
            });
            
            document.getElementById('current-page-input')?.addEventListener('change', function() {
                let page = parseInt(this.value);
                if (isNaN(page) || page < 1) page = 1;
                if (page > state.pagination.totalPages) page = state.pagination.totalPages;
                
                if (page !== state.pagination.currentPage) {
                    state.pagination.currentPage = page;
                    renderAllTransactions();
                    updatePaginationControls();
                }
            });
        }
        
        // 绑定额度自动计算事件 - 优化后的双向联动
        function bindAutoCalculateEvents() {
            // 添加信用卡表单额度自动计算
            const cardLimitInput = document.getElementById('card-limit');
            const cardUsedInput = document.getElementById('card-used');
            const cardRemainingInput = document.getElementById('card-remaining');
            
            // 存储原始值，用于判断哪个字段发生了变化
            let lastLimitValue = cardLimitInput.value;
            let lastUsedValue = cardUsedInput.value;
            let lastRemainingValue = cardRemainingInput.value;
            
            // 信用额度变化处理
            cardLimitInput.addEventListener('input', function() {
                const limit = parseFloat(this.value) || 0;
                const used = parseFloat(cardUsedInput.value) || 0;
                const remaining = parseFloat(cardRemainingInput.value) || 0;
                
                // 如果信用额度变化了
                if (limit !== parseFloat(lastLimitValue)) {
                    // 情况1：已用额度有值，重新计算可用额度
                    if (cardUsedInput.value !== '' && !isNaN(parseFloat(cardUsedInput.value))) {
                        const newRemaining = limit - used;
                        cardRemainingInput.value = newRemaining >= 0 ? formatNumberForInput(newRemaining) : '0';
                    }
                    // 情况2：可用额度有值，重新计算已用额度
                    else if (cardRemainingInput.value !== '' && !isNaN(parseFloat(cardRemainingInput.value))) {
                        const newUsed = limit - remaining;
                        cardUsedInput.value = newUsed >= 0 ? formatNumberForInput(newUsed) : '0';
                    }
                    // 情况3：两个都为空，设置已用额度为0，可用额度=信用额度
                    else {
                        cardUsedInput.value = '0';
                        cardRemainingInput.value = formatNumberForInput(limit);
                    }
                    
                    // 验证和警告
                    validateAddCardInputs();
                }
                
                lastLimitValue = this.value;
            });
            
            // 已用额度变化处理
            cardUsedInput.addEventListener('input', function() {
                const limit = parseFloat(cardLimitInput.value) || 0;
                const used = parseFloat(this.value) || 0;
                
                // 如果已用额度变化了
                if (this.value !== lastUsedValue) {
                    // 自动计算可用额度 = 信用额度 - 已用额度
                    const newRemaining = limit - used;
                    cardRemainingInput.value = newRemaining >= 0 ? formatNumberForInput(newRemaining) : '0';
                    
                    // 验证和警告
                    validateAddCardInputs();
                }
                
                lastUsedValue = this.value;
            });
            
            // 可用额度变化处理
            cardRemainingInput.addEventListener('input', function() {
                const limit = parseFloat(cardLimitInput.value) || 0;
                const remaining = parseFloat(this.value) || 0;
                
                // 如果可用额度变化了
                if (this.value !== lastRemainingValue) {
                    // 自动计算已用额度 = 信用额度 - 可用额度
                    const newUsed = limit - remaining;
                    cardUsedInput.value = newUsed >= 0 ? formatNumberForInput(newUsed) : '0';
                    
                    // 验证和警告
                    validateAddCardInputs();
                }
                
                lastRemainingValue = this.value;
            });
            
            // 编辑信用卡表单额度自动计算
            const editCardLimitInput = document.getElementById('edit-card-limit');
            const editCardUsedInput = document.getElementById('edit-card-used');
            const editCardRemainingInput = document.getElementById('edit-card-remaining');
            
            // 存储原始值，用于判断哪个字段发生了变化
            let lastEditLimitValue = editCardLimitInput.value;
            let lastEditUsedValue = editCardUsedInput.value;
            let lastEditRemainingValue = editCardRemainingInput.value;
            
            // 信用额度变化处理
            editCardLimitInput.addEventListener('input', function() {
                const limit = parseFloat(this.value) || 0;
                const used = parseFloat(editCardUsedInput.value) || 0;
                const remaining = parseFloat(editCardRemainingInput.value) || 0;
                
                // 如果信用额度变化了
                if (limit !== parseFloat(lastEditLimitValue)) {
                    // 情况1：已用额度有值，重新计算可用额度
                    if (editCardUsedInput.value !== '' && !isNaN(parseFloat(editCardUsedInput.value))) {
                        const newRemaining = limit - used;
                        editCardRemainingInput.value = newRemaining >= 0 ? formatNumberForInput(newRemaining) : '0';
                    }
                    // 情况2：可用额度有值，重新计算已用额度
                    else if (editCardRemainingInput.value !== '' && !isNaN(parseFloat(editCardRemainingInput.value))) {
                        const newUsed = limit - remaining;
                        editCardUsedInput.value = newUsed >= 0 ? formatNumberForInput(newUsed) : '0';
                    }
                    // 情况3：两个都为空，设置已用额度为0，可用额度=信用额度
                    else {
                        editCardUsedInput.value = '0';
                        editCardRemainingInput.value = formatNumberForInput(limit);
                    }
                    
                    // 验证和警告
                    validateEditCardInputs();
                }
                
                lastEditLimitValue = this.value;
            });
            
            // 已用额度变化处理
            editCardUsedInput.addEventListener('input', function() {
                const limit = parseFloat(editCardLimitInput.value) || 0;
                const used = parseFloat(this.value) || 0;
                
                // 如果已用额度变化了
                if (this.value !== lastEditUsedValue) {
                    // 自动计算可用额度 = 信用额度 - 已用额度
                    const newRemaining = limit - used;
                    editCardRemainingInput.value = newRemaining >= 0 ? formatNumberForInput(newRemaining) : '0';
                    
                    // 验证和警告
                    validateEditCardInputs();
                }
                
                lastEditUsedValue = this.value;
            });
            
            // 可用额度变化处理
            editCardRemainingInput.addEventListener('input', function() {
                const limit = parseFloat(editCardLimitInput.value) || 0;
                const remaining = parseFloat(this.value) || 0;
                
                // 如果可用额度变化了
                if (this.value !== lastEditRemainingValue) {
                    // 自动计算已用额度 = 信用额度 - 可用额度
                    const newUsed = limit - remaining;
                    editCardUsedInput.value = newUsed >= 0 ? formatNumberForInput(newUsed) : '0';
                    
                    // 验证和警告
                    validateEditCardInputs();
                }
                
                lastEditRemainingValue = this.value;
            });
            
            // 验证添加信用卡表单输入
            function validateAddCardInputs() {
                const limit = parseFloat(cardLimitInput.value) || 0;
                const used = parseFloat(cardUsedInput.value) || 0;
                const remaining = parseFloat(cardRemainingInput.value) || 0;
                
                // 移除所有警告样式
                cardLimitInput.classList.remove('input-warning');
                cardUsedInput.classList.remove('input-warning');
                cardRemainingInput.classList.remove('input-warning');
                
                // 验证逻辑
                if (used > limit) {
                    showToast('已使用额度不能超过信用额度', 'warning');
                    cardUsedInput.classList.add('input-warning');
                }
                
                if (remaining > limit) {
                    showToast('可用额度不能超过信用额度', 'warning');
                    cardRemainingInput.classList.add('input-warning');
                }
                
                if (Math.abs(used + remaining - limit) > 0.01) {
                    cardLimitInput.classList.add('input-warning');
                }
                
                // 移除警告样式
                setTimeout(() => {
                    cardLimitInput.classList.remove('input-warning');
                    cardUsedInput.classList.remove('input-warning');
                    cardRemainingInput.classList.remove('input-warning');
                }, 2000);
            }
            
            // 验证编辑信用卡表单输入
            function validateEditCardInputs() {
                const limit = parseFloat(editCardLimitInput.value) || 0;
                const used = parseFloat(editCardUsedInput.value) || 0;
                const remaining = parseFloat(editCardRemainingInput.value) || 0;
                
                // 移除所有警告样式
                editCardLimitInput.classList.remove('input-warning');
                editCardUsedInput.classList.remove('input-warning');
                editCardRemainingInput.classList.remove('input-warning');
                
                // 验证逻辑
                if (used > limit) {
                    showToast('已使用额度不能超过信用额度', 'warning');
                    editCardUsedInput.classList.add('input-warning');
                }
                
                if (remaining > limit) {
                    showToast('可用额度不能超过信用额度', 'warning');
                    editCardRemainingInput.classList.add('input-warning');
                }
                
                if (Math.abs(used + remaining - limit) > 0.01) {
                    editCardLimitInput.classList.add('input-warning');
                }
                
                // 移除警告样式
                setTimeout(() => {
                    editCardLimitInput.classList.remove('input-warning');
                    editCardUsedInput.classList.remove('input-warning');
                    editCardRemainingInput.classList.remove('input-warning');
                }, 2000);
            }
        }
    </script>
    
    <!-- ================ JavaScript模块：仪表盘管理 ================ -->
    <script>
        // 初始化仪表盘
        function initDashboard() {
            // 更新汇总数据
            updateDashboardSummary();
            // 渲染信用卡列表
            renderDashboardCards();
        }
        
        // 更新仪表板汇总数据
        function updateDashboardSummary() {
            // 计算汇总数据
            const cardsCount = state.cards.length;
            const totalLimit = state.cards.reduce((sum, card) => sum + parseFloat(card.limit), 0);
            const totalUsed = state.cards.reduce((sum, card) => sum + parseFloat(card.used), 0);
            const totalRemaining = totalLimit - totalUsed;
            
            // 更新仪表盘卡片
            document.getElementById('cards-count').textContent = formatNumber(cardsCount, 0);
            document.getElementById('total-limit').textContent = formatCurrency(totalLimit);
            document.getElementById('total-used').textContent = formatCurrency(totalUsed);
            document.getElementById('total-remaining').textContent = formatCurrency(totalRemaining);
        }
        
        // 渲染仪表盘
        function renderDashboard() {
            // 更新仪表板汇总数据
            updateDashboardSummary();
            
            // 渲染信用卡列表（带有账单日徽章）
            renderDashboardCards();
        }
        
        // 渲染仪表盘卡片列表 - 移除了使用率badge
        function renderDashboardCards() {
            const cardsList = document.getElementById('cards-list');
            
            if (state.cards.length === 0) {
                cardsList.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #7f8c8d;">
                        <i class="fas fa-credit-card" style="font-size: 40px; margin-bottom: 10px;"></i>
                        <p>暂无信用卡，点击上方按钮添加</p>
                    </div>
                `;
                return;
            }
            
            let cardsHTML = '';
            state.cards.forEach(card => {
                // 银行名称旁添加账单日徽章
                const bankWithBadge = `
                    <div class="card-bank">
                        <i class="fas fa-university bank-icon"></i>
                        ${card.bank}
                        <span class="bank-bill-day-badge">
                            <i class="fas fa-calendar-day"></i> 账单${card.billDay || 1}日
                        </span>
                    </div>
                `;
                
                cardsHTML += `
                    <div class="card-item">
                        <div class="card-item-header">
                            <div>
                                ${bankWithBadge}
                                <div class="card-number">${formatCardNumber(card.number)}</div>
                            </div>
                        </div>
                        
                        <div class="card-details-grid">
                            <div class="total-limit-section">
                                <div class="total-limit-label">信用额度</div>
                                <div class="total-limit-value">${formatCurrency(card.limit)}</div>
                            </div>
                            
                            <div class="used-remaining-grid">
                                <div class="limit-item">
                                    <div class="limit-label">已使用</div>
                                    <div class="limit-value limit-used">${formatCurrency(card.used)}</div>
                                </div>
                                <div class="limit-item">
                                    <div class="limit-label">剩余</div>
                                    <div class="limit-value limit-remaining">${formatCurrency(card.remaining || (card.limit - card.used))}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="actions">
                            <button class="btn btn-warning" onclick="showEditCardModal('${card.id}')">
                                <i class="fas fa-edit"></i> <span>编辑</span>
                            </button>
                            <button class="btn btn-danger" onclick="showDeleteConfirmModal('${card.id}')">
                                <i class="fas fa-trash"></i> <span>删除</span>
                            </button>
                            <button class="btn btn-info" onclick="showAddTransactionModalForCard('${card.id}')">
                                <i class="fas fa-exchange-alt"></i> <span>添加交易</span>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            cardsList.innerHTML = cardsHTML;
        }
        
        // 切换主选项卡
        function switchMainTab(tabId) {
            state.currentMainTab = tabId;
            
            document.querySelectorAll('.main-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.main-tab[data-main-tab="${tabId}"]`).classList.add('active');
            
            document.querySelectorAll('.main-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabId + '-content').classList.add('active');
            
            // 根据当前选项卡设置渲染标志
            if (tabId === 'dashboard') {
                shouldRenderDashboard = true;
                renderDashboard();
            } else {
                shouldRenderDashboard = false;
            }
            
            if (tabId === 'transactions') {
                shouldRenderTransactions = true;
                switchTransactionTab(state.currentTransactionTab);
            } else {
                shouldRenderTransactions = false;
            }
            
            if (tabId === 'bills') {
                renderMonthGrid();
                renderMonthBillsCards();
            }
        }
    </script>
    
    <!-- ================ JavaScript模块：信用卡管理功能 ================ -->
    <script>
        // ================ 卡片管理功能 ================
        
        // 显示添加信用卡模态框
        function showAddCardModal() {
            document.getElementById('add-card-form').reset();
            document.getElementById('card-limit').value = '10000';
            document.getElementById('card-used').value = '0';
            document.getElementById('card-remaining').value = '10000';
            document.getElementById('bill-day').value = '1';
            document.getElementById('due-days').value = '20'; // 修复：默认间隔20天
            
            showModal('add-card-modal');
        }
        
        // 隐藏添加信用卡模态框
        function hideAddCardModal() {
            hideModal('add-card-modal');
        }
        
        // 添加信用卡
        function addCard(e) {
            e.preventDefault();
            
            const cardNumber = document.getElementById('card-number').value.trim();
            const bank = document.getElementById('card-bank').value;
            const limit = parseFloat(document.getElementById('card-limit').value);
            const usedInput = document.getElementById('card-used').value;
            const remainingInput = document.getElementById('card-remaining').value;
            const billDay = parseInt(document.getElementById('bill-day').value);
            const dueDays = parseInt(document.getElementById('due-days').value); // 修复：获取间隔天数
            
            if (!cardNumber) {
                showToast('请输入信用卡号', 'error');
                return;
            }
            
            if (!bank) {
                showToast('请选择银行', 'error');
                return;
            }
            
            if (isNaN(limit) || limit <= 0) {
                showToast('请输入有效的信用额度', 'error');
                return;
            }
            
            const used = usedInput === '' ? 0 : parseFloat(usedInput);
            const remaining = remainingInput === '' ? limit : parseFloat(remainingInput);
            
            if (used < 0) {
                showToast('已使用额度不能为负数', 'error');
                return;
            }
            
            if (remaining < 0) {
                showToast('可用额度不能为负数', 'error');
                return;
            }
            
            if (used > limit) {
                showToast('已使用额度不能超过信用额度', 'error');
                return;
            }
            
            if (remaining > limit) {
                showToast('可用额度不能超过信用额度', 'error');
                return;
            }
            
            if (Math.abs(used + remaining - limit) > 0.01) {
                showToast('已使用额度 + 可用额度 必须等于信用额度', 'error');
                return;
            }
            
            if (isNaN(billDay) || billDay < 1 || billDay > 28) {
                showToast('账单日必须是1-28之间的数字', 'error');
                return;
            }
            
            if (isNaN(dueDays) || dueDays < 1 || dueDays > 60) {
                showToast('还款间隔天数必须是1-60之间的数字', 'error');
                return;
            }
            
            const card = {
                id: 'card_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                number: cardNumber,
                bank: bank,
                limit: limit.toFixed(2),
                used: used.toFixed(2),
                remaining: remaining.toFixed(2),
                billDay: billDay,
                dueDays: dueDays, // 修复：保存间隔天数
                createdAt: new Date().toISOString()
            };
            
            state.cards.push(card);
            saveAllData();
            
            // 更新界面
            if (shouldRenderDashboard) {
                renderDashboard();
            }
            
            // 如果当前在交易管理页面，更新交易管理界面
            if (shouldRenderTransactions && state.currentTransactionTab === 'all') {
                renderAllTransactions();
            }
            
            // 如果当前在账单管理页面，也更新账单管理界面
            if (state.currentMainTab === 'bills') {
                renderMonthGrid();
                renderMonthBillsCards();
            }
            
            hideAddCardModal();
            showToast('信用卡添加成功！');
        }
        
        // 显示编辑信用卡模态框
        function showEditCardModal(cardId) {
            const card = state.cards.find(c => c.id === cardId);
            if (!card) return;
            
            document.getElementById('edit-card-id').value = card.id;
            document.getElementById('edit-card-number').value = card.number;
            document.getElementById('edit-card-bank').value = card.bank;
            document.getElementById('edit-card-limit').value = formatNumberForInput(card.limit);
            document.getElementById('edit-card-used').value = formatNumberForInput(card.used);
            document.getElementById('edit-card-remaining').value = formatNumberForInput(card.remaining || (parseFloat(card.limit) - parseFloat(card.used)));
            document.getElementById('edit-bill-day').value = card.billDay;
            document.getElementById('edit-due-days').value = card.dueDays || 20; // 修复：显示间隔天数
            
            showModal('edit-card-modal');
        }
        
        // 隐藏编辑信用卡模态框
        function hideEditCardModal() {
            hideModal('edit-card-modal');
        }
        
        // 更新信用卡信息
        function updateCard(e) {
            e.preventDefault();
            
            const cardId = document.getElementById('edit-card-id').value;
            const cardNumber = document.getElementById('edit-card-number').value.trim();
            const bank = document.getElementById('edit-card-bank').value;
            const limit = parseFloat(document.getElementById('edit-card-limit').value);
            const usedInput = document.getElementById('edit-card-used').value;
            const remainingInput = document.getElementById('edit-card-remaining').value;
            const billDay = parseInt(document.getElementById('edit-bill-day').value);
            const dueDays = parseInt(document.getElementById('edit-due-days').value); // 修复：获取间隔天数
            
            if (!cardNumber) {
                showToast('请输入信用卡号', 'error');
                return;
            }
            
            if (!bank) {
                showToast('请选择银行', 'error');
                return;
            }
            
            if (isNaN(limit) || limit <= 0) {
                showToast('请输入有效的信用额度', 'error');
                return;
            }
            
            const used = usedInput === '' ? 0 : parseFloat(usedInput);
            const remaining = remainingInput === '' ? limit : parseFloat(remainingInput);
            
            if (used < 0) {
                showToast('已使用额度不能为负数', 'error');
                return;
            }
            
            if (remaining < 0) {
                showToast('可用额度不能为负数', 'error');
                return;
            }
            
            if (used > limit) {
                showToast('已使用额度不能超过信用额度', 'error');
                return;
            }
            
            if (remaining > limit) {
                showToast('可用额度不能超过信用额度', 'error');
                return;
            }
            
            if (Math.abs(used + remaining - limit) > 0.01) {
                showToast('已使用额度 + 可用额度 必须等于信用额度', 'error');
                return;
            }
            
            if (isNaN(billDay) || billDay < 1 || billDay > 28) {
                showToast('账单日必须是1-28之间的数字', 'error');
                return;
            }
            
            if (isNaN(dueDays) || dueDays < 1 || dueDays > 60) {
                showToast('还款间隔天数必须是1-60之间的数字', 'error');
                return;
            }
            
            const cardIndex = state.cards.findIndex(c => c.id === cardId);
            if (cardIndex === -1) {
                showToast('信用卡不存在', 'error');
                return;
            }
            
            state.cards[cardIndex] = {
                ...state.cards[cardIndex],
                number: cardNumber,
                bank: bank,
                limit: limit.toFixed(2),
                used: used.toFixed(2),
                remaining: remaining.toFixed(2),
                billDay: billDay,
                dueDays: dueDays // 修复：保存间隔天数
            };
            
            saveAllData();
            
            // 更新界面
            if (shouldRenderDashboard) {
                renderDashboard();
            }
            
            // 如果当前在交易管理页面，更新交易管理界面
            if (shouldRenderTransactions && state.currentTransactionTab === 'all') {
                renderAllTransactions();
            }
            
            // 如果当前在账单管理页面，也更新账单管理界面
            if (state.currentMainTab === 'bills') {
                renderMonthGrid();
                renderMonthBillsCards();
            }
            
            hideEditCardModal();
            showToast('信用卡更新成功！');
        }
        
        // 显示删除确认模态框
        function showDeleteConfirmModal(cardId) {
            const card = state.cards.find(c => c.id === cardId);
            if (!card) return;
            
            currentOperation.cardIdToDelete = cardId;
            
            document.getElementById('delete-confirm-message').textContent = 
                `确定要删除这张信用卡吗？\n${card.bank} - ${formatCardNumber(card.number)}\n此操作不可撤销。`;
            
            showModal('delete-confirm-modal');
        }
        
        // 隐藏删除确认模态框
        function hideDeleteConfirmModal() {
            hideModal('delete-confirm-modal');
            currentOperation.cardIdToDelete = null;
        }
        
        // 确认删除信用卡
        function confirmDeleteCard() {
            if (!currentOperation.cardIdToDelete) return;
            
            state.cards = state.cards.filter(c => c.id !== currentOperation.cardIdToDelete);
            state.transactions = state.transactions.filter(t => t.cardId !== currentOperation.cardIdToDelete);
            
            saveAllData();
            
            // 更新界面
            if (shouldRenderDashboard) {
                renderDashboard();
            }
            
            // 如果当前在交易管理页面，更新交易管理界面
            if (shouldRenderTransactions && state.currentTransactionTab === 'all') {
                renderAllTransactions();
            }
            
            // 如果当前在账单管理页面，也更新账单管理界面
            if (state.currentMainTab === 'bills') {
                renderMonthGrid();
                renderMonthBillsCards();
            }
            
            hideDeleteConfirmModal();
            showToast('信用卡删除成功！');
        }
    </script>
    
    <!-- ================ JavaScript模块：交易管理 ================ -->
    <script>
        // 切换交易管理选项卡
        function switchTransactionTab(tabId) {
            state.currentTransactionTab = tabId;
            
            document.querySelectorAll('.transaction-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.transaction-tab[data-transaction-tab="${tabId}"]`).classList.add('active');
            
            document.querySelectorAll('.transaction-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabId + '-transactions-content').classList.add('active');
            
            // 只有设置了渲染标志才渲染对应选项卡的内容
            if (shouldRenderTransactions) {
                if (tabId === 'all') {
                    renderAllTransactions();
                } else if (tabId === 'current') {
                    renderCurrentBillTransactions();
                } else if (tabId === 'next') {
                    renderNextBillTransactions();
                }
            }
        }
        
        // 初始化交易管理
        function initTransactions() {
            // 只更新额外费用汇总，不渲染表格
            updateExtraFeeSummary();
            updatePaginationControls();
        }
        
        // 更新分页控件显示
        function updatePaginationControls() {
            const paginationElement = document.getElementById('all-transactions-pagination');
            if (!paginationElement) return;
            
            // 更新分页信息显示
            document.getElementById('total-transactions').textContent = state.pagination.totalTransactions;
            document.getElementById('total-pages').textContent = state.pagination.totalPages;
            document.getElementById('current-page-input').value = state.pagination.currentPage;
            
            // 更新按钮状态
            document.getElementById('first-page-btn').disabled = state.pagination.currentPage <= 1;
            document.getElementById('prev-page-btn').disabled = state.pagination.currentPage <= 1;
            document.getElementById('next-page-btn').disabled = state.pagination.currentPage >= state.pagination.totalPages;
            document.getElementById('last-page-btn').disabled = state.pagination.currentPage >= state.pagination.totalPages;
            
            // 显示或隐藏分页控件
            if (state.pagination.totalTransactions > state.pagination.pageSize) {
                paginationElement.style.display = 'flex';
            } else {
                paginationElement.style.display = 'none';
            }
        }
        
        // 更新额外费用汇总
        function updateExtraFeeSummary() {
            // 计算全部额外费用
            const totalExtraFee = state.transactions.reduce((sum, transaction) => {
                return sum + (transaction.extraTotalFee || 0);
            }, 0);
            
            // 更新显示
            document.getElementById('current-extra-rate').textContent = `${formatPercent(state.extraFeeSettings.rate * 100)}%`;
            document.getElementById('current-extra-fixed').textContent = `¥${formatAmount(state.extraFeeSettings.fixed)}`;
            document.getElementById('total-extra-fee').textContent = `¥${formatAmount(totalExtraFee)}`;
        }
        
        // 计算额外费用
        function calculateExtraFee() {
            const amount = parseFloat(document.getElementById('transaction-amount').value) || 0;
            const rate = parseFloat(document.getElementById('transaction-extra-rate').value) || 0;
            const fixed = parseFloat(document.getElementById('transaction-extra-fixed').value) || 0;
            
            const extraFee = amount * (rate / 100) + fixed;
            
            document.getElementById('extra-fee-calculation').innerHTML = 
                `${formatAmount(amount)} × ${rate}% + ${formatAmount(fixed)}元 = ${formatAmount(extraFee)}元`;
            
            // 计算并显示年化率
            calculateAndDisplayAnnualizedRate(amount, extraFee, 'extra-fee-annualized');
        }
        
        // 计算编辑额外费用
        function calculateEditExtraFee() {
            const amount = parseFloat(document.getElementById('edit-transaction-amount').value) || 0;
            const rate = parseFloat(document.getElementById('edit-transaction-extra-rate').value) || 0;
            const fixed = parseFloat(document.getElementById('edit-transaction-extra-fixed').value) || 0;
            
            const extraFee = amount * (rate / 100) + fixed;
            
            document.getElementById('edit-extra-fee-calculation').innerHTML = 
                `${formatAmount(amount)} × ${rate}% + ${formatAmount(fixed)}元 = ${formatAmount(extraFee)}元`;
            
            // 计算并显示年化率
            calculateAndDisplayAnnualizedRate(amount, extraFee, 'edit-extra-fee-annualized');
        }
        
        // 计算并显示年化率
        function calculateAndDisplayAnnualizedRate(amount, extraFee, elementId) {
            if (amount <= 0) return;
            
            // 默认假设免息期为30天
            const interestFreeDays = 30;
            const annualizedRate = ((extraFee / (amount - extraFee)) / interestFreeDays * 365 * 100);
            
            document.getElementById(elementId).innerHTML = 
                `年化费率: ${formatPercent(annualizedRate)}% (基于${interestFreeDays}天免息期)`;
        }
        
        // 更新交易卡片选项
        function updateTransactionCardOptions() {
            const cardSelect = document.getElementById('transaction-card');
            const editCardSelect = document.getElementById('edit-transaction-card');
            
            cardSelect.innerHTML = '<option value="">请选择信用卡</option>';
            editCardSelect.innerHTML = '<option value="">请选择信用卡</option>';
            
            state.cards.forEach(card => {
                const option = document.createElement('option');
                option.value = card.id;
                option.textContent = `${card.bank} (${card.number}) - 剩余: ¥${formatAmount(card.limit - card.used)}`;
                cardSelect.appendChild(option);
                
                const editOption = option.cloneNode(true);
                editCardSelect.appendChild(editOption);
            });
        }
        
        // 查找交易所属账单
        function findBillForTransaction(transactionId) {
            return state.bills.find(bill => 
                bill.transactions && bill.transactions.includes(transactionId)
            );
        }
        
        // 显示添加交易模态框
        function showAddTransactionModal() {
            document.getElementById('add-transaction-form').reset();
            document.getElementById('transaction-date').valueAsDate = new Date();
            document.getElementById('transaction-extra-rate').value = formatPercent(state.extraFeeSettings.rate * 100);
            document.getElementById('transaction-extra-fixed').value = state.extraFeeSettings.fixed;
            updateTransactionCardOptions();
            calculateExtraFee();
            
            // 隐藏额外费用选项
            document.getElementById('extra-fee-options').classList.remove('active');
            document.getElementById('toggle-extra-fee').innerHTML = '<i class="fas fa-calculator"></i> 显示额外费用设置';
            
            showModal('add-transaction-modal');
        }
        
        // 隐藏添加交易模态框
        function hideAddTransactionModal() {
            hideModal('add-transaction-modal');
        }
        
        // 添加交易
        function addTransaction(e) {
            e.preventDefault();
            
            // 获取表单数据
            const date = document.getElementById('transaction-date').value;
            const cardId = document.getElementById('transaction-card').value;
            const amount = parseFloat(document.getElementById('transaction-amount').value);
            const description = document.getElementById('transaction-description').value.trim();
            const extraRate = parseFloat(document.getElementById('transaction-extra-rate').value) / 100; // 转换为小数
            const extraFixedFee = parseFloat(document.getElementById('transaction-extra-fixed').value) || 0;
            const extraTotalFee = amount * extraRate + extraFixedFee;
            
            if (!date || !cardId || isNaN(amount) || amount <= 0) {
                showToast('请填写完整的交易信息', 'error');
                return;
            }
            
            const card = state.cards.find(c => c.id === cardId);
            if (!card) {
                showToast('选择的信用卡不存在', 'error');
                return;
            }
            
            // 检查卡片剩余额度是否足够
            const remaining = parseFloat(card.remaining || (card.limit - card.used));
            if (amount > remaining) {
                showToast('消费金额超过信用卡剩余额度！', 'error');
                return;
            }
            
            // 记录交易前的卡片已用额度（用于撤销）
            const cardUsedBefore = card.used;
            
            // 更新额外费用设置
            state.extraFeeSettings.rate = extraRate;
            state.extraFeeSettings.fixed = extraFixedFee;
            
            // 创建交易对象
            const transaction = {
                id: 'trans_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                cardId: cardId,
                cardNumber: card.number,
                bank: card.bank,
                date: date,
                amount: amount,
                description: description || '',
                extraRate: extraRate,
                extraFixedFee: extraFixedFee,
                extraTotalFee: extraTotalFee,
                createdAt: new Date().toISOString()
            };
            
            // 添加到状态
            state.transactions.push(transaction);
            
            // 更新卡片已使用额度
            const cardIndex = state.cards.findIndex(c => c.id === cardId);
            if (cardIndex !== -1) {
                state.cards[cardIndex].used = (parseFloat(state.cards[cardIndex].used) + amount).toFixed(2);
                state.cards[cardIndex].remaining = (parseFloat(state.cards[cardIndex].limit) - parseFloat(state.cards[cardIndex].used)).toFixed(2);
            }
            
            // 更新账单
            updateBillForTransaction(transaction, card);
            
            // 记录操作历史（用于撤销）
            recordOperation({
                type: 'add_transaction',
                timestamp: new Date().toISOString(),
                data: {
                    transaction,
                    cardUsedBefore
                }
            });
            
            // 保存数据
            saveAllData();
            
            // 更新界面
            if (shouldRenderTransactions && state.currentTransactionTab === 'all') {
                renderAllTransactions();
            }
            
            if (shouldRenderTransactions && state.currentTransactionTab === 'current') {
                renderCurrentBillTransactions();
            }
            
            if (shouldRenderTransactions && state.currentTransactionTab === 'next') {
                renderNextBillTransactions();
            }
            
            updateExtraFeeSummary();
            updatePaginationControls();
            
            // 如果当前在账单管理页面，也更新账单管理界面
            if (state.currentMainTab === 'bills') {
                renderMonthGrid();
                renderMonthBillsCards();
            }
            
            // 如果当前在仪表盘页面，也更新仪表盘界面
            if (shouldRenderDashboard) {
                renderDashboard();
            }
            
            // 隐藏模态框
            hideAddTransactionModal();
            
            // 显示成功消息
            showToast('交易记录添加成功！');
        }
        
        // 根据交易更新账单
        function updateBillForTransaction(transaction, card) {
            const transDate = new Date(transaction.date);
            const transYear = transDate.getFullYear();
            const transMonth = transDate.getMonth() + 1;
            const transDay = transDate.getDate();
            
            const billDay = card.billDay || 1;
            
            let billYear, billMonth;
            
            // 规则：如果消费日在账单日之后，计入下个月账单
            if (transDay > billDay) {
                if (transMonth === 12) {
                    billMonth = 1;
                    billYear = transYear + 1;
                } else {
                    billMonth = transMonth + 1;
                    billYear = transYear;
                }
            } else {
                billMonth = transMonth;
                billYear = transYear;
            }
            
            // 查找或创建账单
            const billId = `bill_${transaction.cardId}_${billYear}_${billMonth}`;
            let bill = state.bills.find(b => b.id === billId);
            
            if (!bill) {
                // 计算还款日（使用账单日 + dueDays）
                const billDate = new Date(billYear, billMonth - 1, billDay);
                const dueDate = calculateDueDate(billDate, card.dueDays || 20);
                
                bill = {
                    id: billId,
                    billId: billId,
                    cardId: transaction.cardId,
                    cardNumber: transaction.cardNumber,
                    bank: transaction.bank,
                    year: billYear,
                    month: billMonth,
                    billDay: billDay,
                    dueDays: card.dueDays || 20, // 修复：使用dueDays字段
                    billDate: billDate.toISOString().split('T')[0],
                    dueDate: dueDate.toISOString().split('T')[0],
                    transactions: [],
                    totalAmount: 0,
                    amountDue: 0,
                    paidAmount: 0,
                    isPaid: false,
                    isInstallment: false,
                    installmentInfo: null,
                    createdAt: new Date().toISOString()
                };
                state.bills.push(bill);
            }
            
            // 将交易添加到账单
            if (!bill.transactions.includes(transaction.id)) {
                bill.transactions.push(transaction.id);
                bill.totalAmount += parseFloat(transaction.amount);
                bill.amountDue += parseFloat(transaction.amount);
            }
        }
        
        // 显示编辑交易模态框
        function showEditTransactionModal(transactionId) {
            const transaction = state.transactions.find(t => t.id === transactionId);
            if (!transaction) {
                showToast('交易不存在', 'error');
                return;
            }
            
            // 填充表单数据
            document.getElementById('edit-transaction-id').value = transaction.id;
            document.getElementById('edit-transaction-date').value = transaction.date;
            document.getElementById('edit-transaction-amount').value = transaction.amount;
            document.getElementById('edit-transaction-description').value = transaction.description || '';
            
            // 设置卡片选择
            updateTransactionCardOptions();
            document.getElementById('edit-transaction-card').value = transaction.cardId;
            
            // 设置额外费用
            document.getElementById('edit-transaction-extra-rate').value = formatPercent((transaction.extraRate || 0) * 100);
            document.getElementById('edit-transaction-extra-fixed').value = transaction.extraFixedFee || 0;
            
            calculateEditExtraFee();
            
            // 隐藏额外费用选项
            document.getElementById('edit-extra-fee-options').classList.remove('active');
            document.getElementById('toggle-edit-extra-fee').innerHTML = '<i class="fas fa-calculator"></i> 显示额外费用设置';
            
            showModal('edit-transaction-modal');
        }
        
        // 隐藏编辑交易模态框
        function hideEditTransactionModal() {
            hideModal('edit-transaction-modal');
        }
        
        // 编辑交易提交
        function editTransactionSubmit(e) {
            e.preventDefault();
            
            const transactionId = document.getElementById('edit-transaction-id').value;
            const date = document.getElementById('edit-transaction-date').value;
            const cardId = document.getElementById('edit-transaction-card').value;
            const amount = parseFloat(document.getElementById('edit-transaction-amount').value);
            const description = document.getElementById('edit-transaction-description').value.trim();
            const extraRate = parseFloat(document.getElementById('edit-transaction-extra-rate').value) / 100; // 转换为小数
            const extraFixedFee = parseFloat(document.getElementById('edit-transaction-extra-fixed').value) || 0;
            const extraTotalFee = amount * extraRate + extraFixedFee;
            
            if (!date || !cardId || isNaN(amount) || amount <= 0) {
                showToast('请填写完整的交易信息', 'error');
                return;
            }
            
            const transactionIndex = state.transactions.findIndex(t => t.id === transactionId);
            if (transactionIndex === -1) {
                showToast('交易不存在', 'error');
                return;
            }
            
            const oldTransaction = state.transactions[transactionIndex];
            const oldAmount = oldTransaction.amount;
            const oldCardId = oldTransaction.cardId;
            
            // 如果更换了信用卡或金额有变化，需要调整信用卡额度
            if (cardId !== oldCardId || amount !== oldAmount) {
                // 恢复原卡片的额度
                const oldCardIndex = state.cards.findIndex(c => c.id === oldCardId);
                if (oldCardIndex !== -1) {
                    state.cards[oldCardIndex].used -= oldAmount;
                    if (state.cards[oldCardIndex].used < 0) state.cards[oldCardIndex].used = 0;
                    state.cards[oldCardIndex].remaining = state.cards[oldCardIndex].limit - state.cards[oldCardIndex].used;
                }
                
                // 检查新卡片的剩余额度是否足够
                const newCard = state.cards.find(c => c.id === cardId);
                if (!newCard) {
                    showToast('选择的信用卡不存在', 'error');
                    return;
                }
                
                if (amount > (newCard.limit - newCard.used)) {
                    showToast('消费金额超过信用卡剩余额度！', 'error');
                    // 恢复原卡片的额度
                    if (oldCardIndex !== -1) {
                        state.cards[oldCardIndex].used += oldAmount;
                        state.cards[oldCardIndex].remaining = state.cards[oldCardIndex].limit - state.cards[oldCardIndex].used;
                    }
                    return;
                }
                
                // 更新新卡片的额度
                const newCardIndex = state.cards.findIndex(c => c.id === cardId);
                state.cards[newCardIndex].used += amount;
                state.cards[newCardIndex].remaining = state.cards[newCardIndex].limit - state.cards[newCardIndex].used;
            }
            
            // 更新额外费用设置
            state.extraFeeSettings.rate = extraRate;
            state.extraFeeSettings.fixed = extraFixedFee;
            
            // 更新交易信息
            const updatedTransaction = {
                ...oldTransaction,
                cardId: cardId,
                cardNumber: state.cards.find(c => c.id === cardId).number,
                bank: state.cards.find(c => c.id === cardId).bank,
                date: date,
                amount: amount,
                description: description || '',
                extraRate: extraRate,
                extraFixedFee: extraFixedFee,
                extraTotalFee: extraTotalFee,
                updatedAt: new Date().toISOString()
            };
            
            state.transactions[transactionIndex] = updatedTransaction;
            
            // 重新生成账单（因为交易信息可能已更改）
            regenerateAllBills();
            
            saveAllData();
            
            // 更新界面
            if (shouldRenderTransactions && state.currentTransactionTab === 'all') {
                renderAllTransactions();
            }
            
            if (shouldRenderTransactions && state.currentTransactionTab === 'current') {
                renderCurrentBillTransactions();
            }
            
            if (shouldRenderTransactions && state.currentTransactionTab === 'next') {
                renderNextBillTransactions();
            }
            
            updateExtraFeeSummary();
            updatePaginationControls();
            
            // 如果当前在账单管理页面，也更新账单管理界面
            if (state.currentMainTab === 'bills') {
                renderMonthGrid();
                renderMonthBillsCards();
            }
            
            // 如果当前在仪表盘页面，也更新仪表盘界面
            if (shouldRenderDashboard) {
                renderDashboard();
            }
            
            hideEditTransactionModal();
            showToast('交易修改成功！');
        }
        
        // 显示删除交易模态框
        function showDeleteTransactionModal(transactionId) {
            const transaction = state.transactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
            let deleteHTML = `
                <div style="background-color: #fef5e7; border-left: 4px solid #f39c12; padding: 15px; margin-bottom: 20px;">
                    <h4><i class="fas fa-exclamation-triangle"></i> 确认删除交易</h4>
                    <p>此操作将永久删除以下交易记录，并从相关账单中移除：</p>
                </div>
                
                <div class="bill-item">
                    <div class="bill-item-header">
                        <h3>交易详情</h3>
                    </div>
                    <p><strong>交易日期:</strong> ${formatDate(transaction.date)}</p>
                    <p><strong>交易银行:</strong> ${transaction.bank}</p>
                    <p><strong>交易金额:</strong> ¥${formatAmount(transaction.amount)}</p>
                    <p><strong>交易描述:</strong> ${transaction.description || ''}</p>
                    <p><strong>总额外费用:</strong> ¥${formatAmount(transaction.extraTotalFee || 0)}</p>
                </div>
                
                <div style="margin-top: 15px;">
                    <p><strong>注意：</strong>删除交易后，相关账单金额将减少，信用卡额度将恢复。</p>
                </div>
            `;
            
            document.getElementById('delete-transaction-content').innerHTML = deleteHTML;
            
            // 存储要删除的交易ID
            document.getElementById('confirm-delete-transaction-btn').dataset.transactionId = transactionId;
            
            showModal('delete-transaction-modal');
        }
        
        // 隐藏删除交易模态框
        function hideDeleteTransactionModal() {
            hideModal('delete-transaction-modal');
        }
        
        // 确认删除交易
        function confirmDeleteTransaction() {
            const transactionId = document.getElementById('confirm-delete-transaction-btn').dataset.transactionId;
            const transaction = state.transactions.find(t => t.id === transactionId);
            
            if (!transaction) {
                showToast('交易记录不存在', 'error');
                hideDeleteTransactionModal();
                return;
            }
            
            // 删除交易逻辑
            // 1. 恢复信用卡额度
            const card = state.cards.find(c => c.id === transaction.cardId);
            if (card) {
                card.used -= transaction.amount;
                if (card.used < 0) card.used = 0;
                card.remaining = card.limit - card.used;
            }
            
            // 2. 更新相关账单
            const relatedBills = state.bills.filter(bill => 
                bill.transactions && bill.transactions.includes(transactionId)
            );
            
            relatedBills.forEach(bill => {
                // 从账单交易列表中移除
                bill.transactions = bill.transactions.filter(id => id !== transactionId);
                
                // 减少账单总额
                bill.totalAmount -= transaction.amount;
                bill.amountDue -= transaction.amount;
                if (bill.totalAmount < 0.01) {
                    bill.totalAmount = 0;
                    bill.amountDue = 0;
                    bill.isPaid = false;
                    bill.paidDate = null;
                }
                
                // 如果账单已分期，更新分期信息
                if (bill.isInstallment && bill.installmentInfo) {
                    bill.installmentInfo.totalAmount -= transaction.amount;
                    if (bill.installmentInfo.totalAmount < 0) {
                        bill.installmentInfo.totalAmount = 0;
                    }
                }
            });
            
            // 3. 从交易列表中移除
            state.transactions = state.transactions.filter(t => t.id !== transactionId);
            
            // 4. 清理空的账单
            state.bills = state.bills.filter(bill => 
                !(bill.transactions.length === 0 && bill.totalAmount === 0)
            );
            
            // 保存数据
            saveAllData();
            
            // 更新界面
            if (shouldRenderTransactions && state.currentTransactionTab === 'all') {
                renderAllTransactions();
            }
            
            if (shouldRenderTransactions && state.currentTransactionTab === 'current') {
                renderCurrentBillTransactions();
            }
            
            if (shouldRenderTransactions && state.currentTransactionTab === 'next') {
                renderNextBillTransactions();
            }
            
            updateExtraFeeSummary();
            updatePaginationControls();
            
            // 如果当前在账单管理页面，也更新账单管理页面
                if (state.currentMainTab === 'bills') {
                renderMonthGrid();
                renderMonthBillsCards();
            }
            
            // 如果当前在仪表盘页面，也更新仪表盘界面
            if (shouldRenderDashboard) {
                renderDashboard();
            }
            
            // 隐藏模态框
            hideDeleteTransactionModal();
            
            showToast('交易已删除，相关账单和额度已更新', 'success');
        }
        
        // 重新生成所有账单 - 修复：先释放分期手续费占用额度，再重新生成
function regenerateAllBills() {
    if (state.cards.length === 0) {
        showToast('请先添加信用卡', 'error');
        return;
    }
    
    // ================ 新增：释放分期手续费占用的额度 ================
    console.log('开始释放分期手续费占用额度...');
    
    // 用于记录总共释放了多少额度
    let totalReleasedFee = 0;
    
    // 遍历所有卡片，释放分期手续费占用的额度
    state.cards.forEach(card => {
        // 查找该卡的所有分期记录
        const cardInstallments = state.installments.filter(inst => inst.cardId === card.id);
        
        // 计算该卡所有分期计划的总手续费
        let cardTotalFee = 0;
        cardInstallments.forEach(installment => {
            // 如果分期记录中有总手续费字段，直接使用
            if (installment.totalFee !== undefined) {
                cardTotalFee += parseFloat(installment.totalFee);
            } else {
                // 否则根据分期金额、期数和费率计算
                const period = installment.period || 0;
                const feeRate = installment.feeRate || 0;
                const amount = installment.amount || 0;
                cardTotalFee += amount * feeRate * period;
            }
        });
        
        // 如果有分期手续费占用额度，则释放
        if (cardTotalFee > 0) {
            // 找到卡片索引
            const cardIndex = state.cards.findIndex(c => c.id === card.id);
            if (cardIndex !== -1) {
                const beforeUsed = state.cards[cardIndex].used;
                const newUsed = Math.max(0, parseFloat(beforeUsed) - cardTotalFee);
                
                state.cards[cardIndex].used = newUsed.toFixed(2);
                state.cards[cardIndex].remaining = (parseFloat(state.cards[cardIndex].limit) - newUsed).toFixed(2);
                
                totalReleasedFee += cardTotalFee;
                
                console.log(`卡片 ${card.bank} (${formatCardNumber(card.number)}) 释放分期手续费占用额度: ¥${formatAmount(cardTotalFee)}`);
            }
        }
    });
    
    console.log(`总计释放分期手续费占用额度: ¥${formatAmount(totalReleasedFee)}`);

            
            // 清空现有账单和分期记录
            state.bills = [];
            state.installments = [];
            
            // 重新为所有交易生成账单
            state.transactions.forEach(transaction => {
                const card = state.cards.find(c => c.id === transaction.cardId);
                if (card) {
                    updateBillForTransaction(transaction, card);
                }
            });
            
            saveAllData();
            
            // 更新界面
            if (shouldRenderTransactions) {
                if (state.currentTransactionTab === 'all') {
                    renderAllTransactions();
                } else if (state.currentTransactionTab === 'current') {
                    renderCurrentBillTransactions();
                } else if (state.currentTransactionTab === 'next') {
                    renderNextBillTransactions();
                }
            }
            
            if (state.currentMainTab === 'bills') {
                renderMonthGrid();
                renderMonthBillsCards();
            }
            
            // 如果当前在仪表盘页面，也更新仪表盘界面
    if (shouldRenderDashboard) {
        renderDashboard();
    }
    
    // 步骤3：修改后的提示信息
    if (totalReleasedFee > 0) {
        showToast(`所有账单已重新生成！释放分期手续费占用额度 ¥${formatAmount(totalReleasedFee)}，分期记录已清空。`);
    } else {
        showToast('所有账单已重新生成！分期记录已清空。');
    }
}        
       
        // 渲染全部交易列表（表格形式）- 支持分页
        function renderAllTransactions() {
            const transactionsList = document.getElementById('all-transactions-list');
            
            if (state.transactions.length === 0) {
                transactionsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exchange-alt"></i>
                        <h3>暂无交易记录</h3>
                        <p>点击上方按钮添加你的第一笔交易</p>
                    </div>
                `;
                
                // 隐藏分页控件
                document.getElementById('all-transactions-pagination').style.display = 'none';
                return;
            }
            
            // 按日期倒序排序，同一天按创建时间倒序（最新在前）
            const sortedTransactions = [...state.transactions].sort((a, b) => {
                // 先按日期倒序
                const dateDiff = new Date(b.date) - new Date(a.date);
                if (dateDiff !== 0) return dateDiff;
                
                // 同一天按创建时间倒序
                return new Date(b.createdAt) - new Date(a.createdAt);
            });
            
            // 计算分页
            const startIndex = (state.pagination.currentPage - 1) * state.pagination.pageSize;
            const endIndex = Math.min(startIndex + state.pagination.pageSize, sortedTransactions.length);
            const currentPageTransactions = sortedTransactions.slice(startIndex, endIndex);
            
            let tableHTML = `
                <div class="transactions-table-container">
                    <table class="transactions-table">
                        <thead>
                            <tr>
                                <th>日期</th>
                                <th>银行</th>
                                <th>摘述</th>
                                <th>消费金额</th>
                                <th>总额外费用</th>
                                <th>免息期</th>
                                <th>额外费用年化率</th>
                                <th>所属账单</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            currentPageTransactions.forEach(transaction => {
                // 查找交易所属的账单
                const bill = findBillForTransaction(transaction.id);
                
                // 计算免息期和额外费用年化率
                let interestFreeDays = 0;
                let extraAnnualizedRate = '0.00%';
                
                if (bill) {
                    interestFreeDays = calculateInterestFreeDays(transaction.date, bill.dueDate);
                    extraAnnualizedRate = calculateExtraAnnualizedRate(transaction.extraTotalFee || 0, transaction.amount, transaction.date, bill.dueDate) + '%';
                }
                
                // 格式化金额样式
                const amountClass = "amount-cell";
                const extraFeeClass = "extra-fee-cell";
                
                // 限制描述长度
                const description = transaction.description || '';
                const shortDescription = description.length > 15 ? description.substring(0, 15) + '...' : description;
                
                tableHTML += `
                    <tr>
                        <td>${formatDate(transaction.date)}</td>
                        <td>${transaction.bank}</td>
                        <td title="${description}">${shortDescription}</td>
                        <td class="${amountClass}">¥${formatAmount(transaction.amount)}</td>
                        <td class="${extraFeeClass}">¥${formatAmount(transaction.extraTotalFee || 0)}</td>
                        <td>${interestFreeDays}天</td>
                        <td>${extraAnnualizedRate}</td>
                        <td>
                            ${bill ? 
                                `<span class="bill-link">${bill.year}年${bill.month}月账单</span>` : 
                                '<span class="no-bill">未生成账单</span>'
                            }
                        </td>
                        <td class="actions-cell">
                            <div class="action-buttons">
                                <button class="action-btn action-btn-edit" onclick="showEditTransactionModal('${transaction.id}')" title="编辑">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn action-btn-delete" onclick="showDeleteTransactionModal('${transaction.id}')" title="删除">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            transactionsList.innerHTML = tableHTML;
            
            // 更新分页控件
            updatePaginationControls();
        }
        
        // 渲染本期账单交易
        function renderCurrentBillTransactions() {
            const transactionsList = document.getElementById('current-transactions-list');
            
            // 获取当前日期
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1;
            
            // 获取本期账单的交易
            let currentTransactions = [];
            
            state.transactions.forEach(transaction => {
                const card = state.cards.find(c => c.id === transaction.cardId);
                if (!card) return;
                
                const transDate = new Date(transaction.date);
                const transYear = transDate.getFullYear();
                const transMonth = transDate.getMonth() + 1;
                const transDay = transDate.getDate();
                
                // 账单日
                const billDay = card.billDay || 1;
                
                // 判断交易属于哪期账单
                let billYear, billMonth;
                
                if (transDay > billDay) {
                    // 计入下个月账单
                    if (transMonth === 12) {
                        billMonth = 1;
                        billYear = transYear + 1;
                    } else {
                        billMonth = transMonth + 1;
                        billYear = transYear;
                    }
                } else {
                    // 计入当月账单
                    billMonth = transMonth;
                    billYear = transYear;
                }
                
                // 如果属于本期账单
                if (billYear === currentYear && billMonth === currentMonth) {
                    currentTransactions.push(transaction);
                }
            });
            
            if (currentTransactions.length === 0) {
                transactionsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-calendar-week"></i>
                        <h3>本期账单暂无交易</h3>
                        <p>本期账单中还没有交易记录</p>
                    </div>
                `;
                return;
            }
            
            // 按日期倒序排序，同一天按创建时间倒序（最新在前）
            const sortedTransactions = [...currentTransactions].sort((a, b) => {
                // 先按日期倒序
                const dateDiff = new Date(b.date) - new Date(a.date);
                if (dateDiff !== 0) return dateDiff;
                
                // 同一天按创建时间倒序
                return new Date(b.createdAt) - new Date(a.createdAt);
            });
            
            let tableHTML = `
                <div class="transactions-table-container">
                    <table class="transactions-table">
                        <thead>
                            <tr>
                                <th>日期</th>
                                <th>银行</th>
                                <th>摘述</th>
                                <th>消费金额</th>
                                <th>总额外费用</th>
                                <th>免息期</th>
                                <th>额外费用年化率</th>
                                <th>所属账单</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            sortedTransactions.forEach(transaction => {
                // 查找交易所属的账单
                const bill = findBillForTransaction(transaction.id);
                
                // 计算免息期和额外费用年化率
                let interestFreeDays = 0;
                let extraAnnualizedRate = '0.00%';
                
                if (bill) {
                    interestFreeDays = calculateInterestFreeDays(transaction.date, bill.dueDate);
                    extraAnnualizedRate = calculateExtraAnnualizedRate(transaction.extraTotalFee || 0, transaction.amount, transaction.date, bill.dueDate) + '%';
                }
                
                // 格式化金额样式
                const amountClass = "amount-cell";
                const extraFeeClass = "extra-fee-cell";
                
                // 限制描述长度
                const description = transaction.description || '';
                const shortDescription = description.length > 15 ? description.substring(0, 15) + '...' : description;
                
                tableHTML += `
                    <tr>
                        <td>${formatDate(transaction.date)}</td>
                        <td>${transaction.bank}</td>
                        <td title="${description}">${shortDescription}</td>
                        <td class="${amountClass}">¥${formatAmount(transaction.amount)}</td>
                        <td class="${extraFeeClass}">¥${formatAmount(transaction.extraTotalFee || 0)}</td>
                        <td>${interestFreeDays}天</td>
                        <td>${extraAnnualizedRate}</td>
                        <td>
                            ${bill ? 
                                `<span class="bill-link">${bill.year}年${bill.month}月账单</span>` : 
                                '<span class="no-bill">未生成账单</span>'
                            }
                        </td>
                        <td class="actions-cell">
                            <div class="action-buttons">
                                <button class="action-btn action-btn-edit" onclick="showEditTransactionModal('${transaction.id}')" title="编辑">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn action-btn-delete" onclick="showDeleteTransactionModal('${transaction.id}')" title="删除">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            transactionsList.innerHTML = tableHTML;
        }
        
        // 渲染下期账单交易
        function renderNextBillTransactions() {
            const transactionsList = document.getElementById('next-transactions-list');
            
            // 获取当前日期
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1;
            
            // 计算下个月
            let nextYear = currentYear;
            let nextMonth = currentMonth + 1;
            
            if (nextMonth > 12) {
                nextMonth = 1;
                nextYear = currentYear + 1;
            }
            
            // 获取下期账单的交易
            let nextTransactions = [];
            
            state.transactions.forEach(transaction => {
                const card = state.cards.find(c => c.id === transaction.cardId);
                if (!card) return;
                
                const transDate = new Date(transaction.date);
                const transYear = transDate.getFullYear();
                const transMonth = transDate.getMonth() + 1;
                const transDay = transDate.getDate();
                
                // 账单日
                const billDay = card.billDay || 1;
                
                // 判断交易属于哪期账单
                let billYear, billMonth;
                
                if (transDay > billDay) {
                    // 计入下个月账单
                    if (transMonth === 12) {
                        billMonth = 1;
                        billYear = transYear + 1;
                    } else {
                        billMonth = transMonth + 1;
                        billYear = transYear;
                    }
                } else {
                    // 计入当月账单
                    billMonth = transMonth;
                    billYear = transYear;
                }
                
                // 如果属于下期账单
                if (billYear === nextYear && billMonth === nextMonth) {
                    nextTransactions.push(transaction);
                }
            });
            
            if (nextTransactions.length === 0) {
                transactionsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-calendar-alt"></i>
                        <h3>下期账单暂无交易</h3>
                        <p>下期账单中还没有交易记录</p>
                    </div>
                `;
                return;
            }
            
            // 按日期倒序排序，同一天按创建时间倒序（最新在前）
            const sortedTransactions = [...nextTransactions].sort((a, b) => {
                // 先按日期倒序
                const dateDiff = new Date(b.date) - new Date(a.date);
                if (dateDiff !== 0) return dateDiff;
                
                // 同一天按创建时间倒序
                return new Date(b.createdAt) - new Date(a.createdAt);
            });
            
            let tableHTML = `
                <div class="transactions-table-container">
                    <table class="transactions-table">
                        <thead>
                            <tr>
                                <th>日期</th>
                                <th>银行</th>
                                <th>摘述</th>
                                <th>消费金额</th>
                                <th>总额外费用</th>
                                <th>免息期</th>
                                <th>额外费用年化率</th>
                                <th>所属账单</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            sortedTransactions.forEach(transaction => {
                // 查找交易所属的账单
                const bill = findBillForTransaction(transaction.id);
                
                // 计算免息期和额外费用年化率
                let interestFreeDays = 0;
                let extraAnnualizedRate = '0.00%';
                
                if (bill) {
                    interestFreeDays = calculateInterestFreeDays(transaction.date, bill.dueDate);
                    extraAnnualizedRate = calculateExtraAnnualizedRate(transaction.extraTotalFee || 0, transaction.amount, transaction.date, bill.dueDate) + '%';
                }
                
                // 格式化金额样式
                const amountClass = "amount-cell";
                const extraFeeClass = "extra-fee-cell";
                
                // 限制描述长度
                const description = transaction.description || '';
                const shortDescription = description.length > 15 ? description.substring(0, 15) + '...' : description;
                
                tableHTML += `
                    <tr>
                        <td>${formatDate(transaction.date)}</td>
                        <td>${transaction.bank}</td>
                        <td title="${description}">${shortDescription}</td>
                        <td class="${amountClass}">¥${formatAmount(transaction.amount)}</td>
                        <td class="${extraFeeClass}">¥${formatAmount(transaction.extraTotalFee || 0)}</td>
                        <td>${interestFreeDays}天</td>
                        <td>${extraAnnualizedRate}</td>
                        <td>
                            ${bill ? 
                                `<span class="bill-link">${bill.year}年${bill.month}月账单</span>` : 
                                '<span class="no-bill">未生成账单</span>'
                            }
                        </td>
                        <td class="actions-cell">
                            <div class="action-buttons">
                                <button class="action-btn action-btn-edit" onclick="showEditTransactionModal('${transaction.id}')" title="编辑">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn action-btn-delete" onclick="showDeleteTransactionModal('${transaction.id}')" title="删除">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            transactionsList.innerHTML = tableHTML;
        }
    </script>
    
    <!-- ================ JavaScript模块：账单管理 ================ -->
    <script>
        // 初始化账单管理
        function initBillsManagement() {
            updateYearDisplay();
            renderMonthGrid();
            renderMonthBillsCards();
        }
        
        // 更新年份显示
        function updateYearDisplay() {
            document.getElementById('current-year-display').textContent = `${state.selectedYear}年`;
            
            const prevYearBtn = document.getElementById('prev-year-btn');
            const nextYearBtn = document.getElementById('next-year-btn');
            
            prevYearBtn.disabled = state.selectedYear <= 2020;
            nextYearBtn.disabled = state.selectedYear >= 2030;
        }
        
        // 渲染月份网格
        function renderMonthGrid() {
            const monthGrid = document.getElementById('month-grid');
            if (!monthGrid) return;
            
            let gridHTML = '';
            
            for (let month = 1; month <= 12; month++) {
                // 获取该月的所有账单（包括分期子账单）
                const monthBills = state.bills.filter(bill => 
                    bill.year == state.selectedYear && 
                    bill.month === month
                );
                
                // 按卡片分组
                const cardBillsMap = new Map();
                let monthTotalAmount = 0;
                let cardCount = 0;
                
                monthBills.forEach(bill => {
                    if (!cardBillsMap.has(bill.cardId)) {
                        cardBillsMap.set(bill.cardId, []);
                        cardCount++;
                    }
                    cardBillsMap.get(bill.cardId).push(bill);
                    
                    // 计算未还款金额
                    if (!bill.isPaid) {
                        monthTotalAmount += bill.amountDue || bill.totalAmount || 0;
                    }
                });
                
                const isSelected = month == state.selectedMonth;
                
                let btnClasses = 'month-grid-btn';
                if (cardCount > 0) btnClasses += ' has-bill';
                if (isSelected) btnClasses += ' active';
                
                gridHTML += `
                    <button class="${btnClasses}" data-month="${month}" onclick="selectMonth(${month})">
                        <div class="month-grid-name">${month}月</div>
                        ${cardCount > 0 ? `
                            <div class="month-grid-amount">¥${formatAmount(monthTotalAmount)}</div>
                            <div class="month-grid-count">${cardCount}张卡</div>
                        ` : `
                            <div class="month-grid-amount">无账单</div>
                        `}
                    </button>
                `;
            }
            
            monthGrid.innerHTML = gridHTML;
        }
        
        // 选择月份
        function selectMonth(month) {
            state.selectedMonth = month;
            
            document.querySelectorAll('.month-grid-btn').forEach(btn => btn.classList.remove('active'));
            const monthBtn = document.querySelector(`.month-grid-btn[data-month="${month}"]`);
            if (monthBtn) monthBtn.classList.add('active');
            
            renderMonthBillsCards();
        }
        
        // 渲染月份账单卡片
        function renderMonthBillsCards() {
            const container = document.getElementById('monthly-bills-container');
            
            if (state.cards.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <h3>暂无信用卡</h3>
                        <p>请先添加信用卡</p>
                    </div>
                `;
                return;
            }
            
            // 获取该月所有账单（包括分期子账单）
            const monthBills = state.bills.filter(bill => 
                bill.year == state.selectedYear && 
                bill.month === state.selectedMonth
            );
            
            // 按卡片分组账单
            const cardBillsMap = new Map();
            monthBills.forEach(bill => {
                if (!cardBillsMap.has(bill.cardId)) {
                    cardBillsMap.set(bill.cardId, []);
                }
                cardBillsMap.get(bill.cardId).push(bill);
            });
            
            // 创建卡片数组，有账单的卡片排在前面
            let sortedCards = [...state.cards];
            
            sortedCards.sort((a, b) => {
                const aHasBill = cardBillsMap.has(a.id);
                const bHasBill = cardBillsMap.has(b.id);
                
                if (aHasBill && !bHasBill) return -1;
                if (!aHasBill && bHasBill) return 1;
                
                // 如果都有账单或都没有账单，按银行名称排序
                return a.bank.localeCompare(b.bank);
            });
            
            // 如果没有任何账单
            if (sortedCards.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <h3>${state.selectedYear}年${state.selectedMonth}月暂无账单</h3>
                        <p>该月份还没有账单记录</p>
                    </div>
                `;
                return;
            }
            
            let cardsHTML = `
                <h3 style="margin-bottom: 15px; color: var(--primary-color);">
                    <i class="fas fa-calendar-alt"></i> ${state.selectedYear}年${state.selectedMonth}月账单
                </h3>
                <div class="bill-cards-container">
            `;
            
            // 显示所有卡片
            sortedCards.forEach(card => {
                const cardBills = cardBillsMap.get(card.id) || [];
                
                // 计算总应还金额（包括主账单和分期子账单）
                let totalDueAmount = 0;
                let mainBill = null;
                let installmentBills = [];
                
                cardBills.forEach(bill => {
                    if (bill.installmentPhase) {
                        installmentBills.push(bill);
                    } else {
                        mainBill = bill;
                    }
                    
                    if (!bill.isPaid) {
                        totalDueAmount += bill.amountDue || bill.totalAmount || 0;
                    }
                });
                
                const hasBill = totalDueAmount > 0 || cardBills.length > 0;
                
                // 计算还款日
                let dueDateText = '';
                if (mainBill && mainBill.dueDate) {
                    dueDateText = formatDate(mainBill.dueDate);
                }
                
                // 检查是否全部已还
                const isFullyPaid = totalDueAmount <= 0 && cardBills.length > 0;
                
                // 银行名称旁添加账单日徽章
                const bankWithBadge = `
                    <div class="bill-card-title">
                        <i class="fas fa-university bill-card-bank-icon"></i>
                        ${card.bank} (${formatCardNumber(card.number)})
                        <span class="bank-bill-day-badge">
                            <i class="fas fa-calendar-day"></i> 账单${card.billDay || 1}日
                        </span>
                    </div>
                `;
                
                cardsHTML += `
                    <div class="bill-card">
                        <div class="bill-card-header">
                            ${bankWithBadge}
                            ${hasBill ? 
                                `<span class="bill-card-status ${isFullyPaid ? 'status-paid' : 'status-unpaid'}">
                                    ${isFullyPaid ? '已还款' : '未还款'}
                                </span>` :
                                `<span class="bill-card-status" style="background-color: #f0f0f0; color: #999;">无账单</span>`
                            }
                        </div>
                        
                        <div class="bill-card-body">
                            <div class="bill-card-row">
                                <span class="bill-card-label">本期应还总额</span>
                                <span class="bill-card-value large">¥${formatAmount(totalDueAmount)}</span>
                            </div>
                            
                            ${hasBill ? `
                                <div class="bill-card-row">
                                    <span class="bill-card-label">还款日</span>
                                    <span class="bill-card-value">${dueDateText}</span>
                                </div>
                                ${installmentBills.length > 0 ? `
                                    <div class="bill-card-row">
                                        <span class="bill-card-label">分期账单</span>
                                        <span class="bill-card-value">${installmentBills.length}笔</span>
                                    </div>
                                ` : ''}
                            ` : ''}
                        </div>
                        
                        <div class="form-row">
                            <button class="btn btn-info" onclick="showAddTransactionModalForCard('${card.id}')">
                                <i class="fas fa-plus"></i> 添加交易
                            </button>
                            ${hasBill ? `
                                <button class="btn btn-primary" onclick="showBillDetail('${card.id}', ${state.selectedYear}, ${state.selectedMonth})">
                                    <i class="fas fa-eye"></i> 详情
                                </button>
                                ${!isFullyPaid && totalDueAmount > 0 ? `
                                    <button class="btn btn-warning" onclick="showInstallmentModal('${card.id}', ${state.selectedYear}, ${state.selectedMonth})">
                                        <i class="fas fa-calendar-check"></i> 分期
                                    </button>
                                    <button class="btn btn-success" onclick="showConsolidatedRepaymentModal('${card.id}', ${state.selectedYear}, ${state.selectedMonth})">
                                        <i class="fas fa-check"></i> 还款
                                    </button>
                                ` : `
                                    <button class="btn btn-success" onclick="showToast('账单已还清', 'info')" disabled>
                                        <i class="fas fa-check"></i> 已还清
                                    </button>
                                `}
                            ` : `
                                <button class="btn btn-primary" onclick="showToast('本月无账单', 'info')" disabled>
                                    <i class="fas fa-eye"></i> 详情
                                </button>
                                <button class="btn btn-warning" onclick="showToast('本月无账单', 'info')" disabled>
                                    <i class="fas fa-calendar-check"></i> 分期
                                </button>
                                <button class="btn btn-success" onclick="showToast('本月无账单', 'info')" disabled>
                                    <i class="fas fa-check"></i> 还款
                                </button>
                            `}
                        </div>
                    </div>
                `;
            });
            
            cardsHTML += `</div>`;
            container.innerHTML = cardsHTML;
        }
    </script>
    
    <!-- ================ JavaScript模块：账单详情功能 ================ -->
    <script>
        // 显示账单详情 - 修复：根据要求优化显示
        function showBillDetail(cardId, year, month) {
            const card = state.cards.find(c => c.id === cardId);
            if (!card) return;
            
            // 获取该月该卡的所有账单
            const cardBills = state.bills.filter(bill => 
                bill.cardId === cardId && 
                bill.year == year && 
                bill.month === month
            );
            
            // 分离主账单和分期子账单
            const mainBill = cardBills.find(bill => !bill.installmentPhase);
            const installmentSubBills = cardBills.filter(bill => bill.installmentPhase);
            
            // 计算总应还金额
            let totalDueAmount = 0;
            cardBills.forEach(bill => {
                if (!bill.isPaid) {
                    totalDueAmount += bill.amountDue || bill.totalAmount || 0;
                }
            });
            
            // 计算分期子账单总金额
            let installmentTotalAmount = 0;
            installmentSubBills.forEach(bill => {
                installmentTotalAmount += bill.amountDue || bill.totalAmount || 0;
            });
            
            // 设置模态框标题（包含账单日徽章）
            const titleHTML = `
                ${card.bank} (${formatCardNumber(card.number)}) - ${year}年${month}月账单
                <span class="bank-bill-day-badge" style="margin-left: 10px;">
                    <i class="fas fa-calendar-day"></i> 账单${card.billDay || 1}日
                </span>
            `;
            document.getElementById('bill-detail-title').innerHTML = titleHTML;
            
            let detailHTML = '';
            
            if (cardBills.length === 0) {
                detailHTML = `
                    <div class="bill-detail-info">
                        <h3 style="margin-bottom: 10px;">暂无账单</h3>
                        <p>该月份还没有生成账单</p>
                    </div>
                `;
            } else {
                // 获取账单日（格式化为01月01日）
                const billDay = mainBill ? mainBill.billDay : (card.billDay || 1);
                const billDayFormatted = `${billDay.toString().padStart(2, '0')}月${billDay.toString().padStart(2, '0')}日`;
                
                // 计算还款日（不再显示天数）
                let dueDateText = '';
                if (mainBill && mainBill.dueDate) {
                    dueDateText = formatDate(mainBill.dueDate);
                }
                
                // 获取间隔天数
                const dueDays = mainBill ? (mainBill.dueDays || card.dueDays || 20) : (card.dueDays || 20);
                
                detailHTML = `
                    <div class="bill-detail-info">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0;">账单详情</h3>
                            <div style="background-color: #f0f7ff; padding: 6px 12px; border-radius: 12px; font-size: 13px; color: var(--secondary-color); font-weight: 500;">
                                账单日: ${month}月${billDay}日 | 还款间隔: ${dueDays}天
                            </div>
                        </div>
                        
                        <div class="bill-detail-summary">
                            <div class="bill-detail-item">
                                <div class="bill-detail-item-label">账单总额</div>
                                <div class="bill-detail-item-value amount">¥${formatAmount(totalDueAmount)}</div>
                            </div>
                            
                            <div class="bill-detail-item">
                                <div class="bill-detail-item-label">还款日</div>
                                <div class="bill-detail-item-value">${dueDateText}</div>
                            </div>
                            
                            <div class="bill-detail-item">
                                <div class="bill-detail-item-label">账单状态</div>
                                <div class="bill-detail-item-value">${totalDueAmount <= 0 ? '已还清' : '未还款'}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                // ============ 原账单分期详情 ============
                if (mainBill && mainBill.isInstallment && mainBill.installmentInfo) {
                    // 计算剩余未还期数
                    const installmentInfo = mainBill.installmentInfo;
                    const totalPhases = installmentInfo.period;
                    
                    // 查找该分期计划的未还子账单
                    const installmentId = mainBill.installmentId;
                    const installmentSubBillsForPlan = state.bills.filter(bill => 
                        bill.installmentId === installmentId && 
                        bill.installmentPhase
                    );
                    
                    // 计算未还子账单数量
                    const unpaidSubBills = installmentSubBillsForPlan.filter(bill => !bill.isPaid);
                    const remainingPhases = unpaidSubBills.length;
                    
                    const installmentStatus = remainingPhases === 0 ? '已全部还清' : 
                                            remainingPhases === totalPhases ? '全部未还' : 
                                            `已分期，剩余${remainingPhases}期未还`;
                    
                    // 计算状态颜色
                    let statusColor = '#27ae60'; // 绿色：已还清
                    let statusBg = '#d5f4e6';
                    
                    if (remainingPhases > 0 && remainingPhases < totalPhases) {
                        statusColor = '#f39c12'; // 橙色：部分还款
                        statusBg = '#fef5e7';
                    } else if (remainingPhases === totalPhases) {
                        statusColor = '#e74c3c'; // 红色：全部未还
                        statusBg = '#fdeaea';
                    }
                    
                    // 修复：显示已分期金额
                    const installmentAmount = installmentInfo.totalAmount || 0;
                    
                    detailHTML += `
                        <div class="original-installment-detail">
                            <h4 style="margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-calendar-check"></i> 原账单分期计划
                                <span class="original-installment-status" style="background-color: ${statusBg}; color: ${statusColor};">
                                    ${installmentStatus}
                                </span>
                            </h4>
                            
                            <div class="original-installment-summary">
                                <div class="original-installment-item">
                                    <div class="original-installment-label">分期总金额</div>
                                    <div class="original-installment-value">¥${formatAmount(installmentAmount)}</div>
                                </div>
                                
                                <div class="original-installment-item">
                                    <div class="original-installment-label">分期期数</div>
                                    <div class="original-installment-value">${totalPhases}期</div>
                                </div>
                                
                                <div class="original-installment-item">
                                    <div class="original-installment-label">每期还款</div>
                                    <div class="original-installment-value">¥${formatAmount(installmentInfo.monthlyPayment)}</div>
                                    <div style="font-size: 12px; color: #7f8c8d; margin-top: 3px;">
                                        其中本金¥${formatAmount(installmentInfo.monthlyPrincipal)}，手续费¥${formatAmount(installmentInfo.monthlyFee)}
                                    </div>
                                </div>
                                
                                <div class="original-installment-item">
                                    <div class="original-installment-label">总手续费</div>
                                    <div class="original-installment-value">¥${formatAmount(installmentInfo.totalFee)}</div>
                                </div>
                            </div>
                            
                            <button class="original-installment-toggle" id="toggle-original-installment-detail">
                                <i class="fas fa-chevron-down"></i> 显示分期明细
                            </button>
                            
                            <div class="installment-detail-content" id="original-installment-detail-content" style="margin-top: 15px;">
                                <h5 style="margin-bottom: 10px; color: var(--primary-color);">分期明细（共${totalPhases}期）:</h5>
                    `;
                    
                    // 生成分期明细
                    for (let i = 1; i <= totalPhases; i++) {
                        // 查找对应的子账单
                        const subBill = installmentSubBillsForPlan.find(bill => bill.installmentPhase === i);
                        const isPaid = subBill ? subBill.isPaid : false;
                        const dueDate = subBill ? subBill.dueDate : '';
                        
                        // 计算子账单关联月份
                        const installmentMonthCalc = calculateInstallmentMonth(year, month, i);
                        const billYear = installmentMonthCalc.year;
                        const billMonth = installmentMonthCalc.month;
                        
                        detailHTML += `
                            <div class="installment-phase" style="margin-bottom: 10px; ${isPaid ? 'background-color: #f0fff8; border-left-color: #27ae60;' : ''}">
                                <div class="installment-phase-header">
                                    <span>第${i}期 (${billYear}年${billMonth}月) ${isPaid ? '✓ 已还' : ''}</span>
                                    <span>¥${formatAmount(installmentInfo.monthlyPayment)}</span>
                                </div>
                                <div class="installment-detail-item">
                                    <span>本金</span>
                                    <span>¥${formatAmount(installmentInfo.monthlyPrincipal)}</span>
                                </div>
                                <div class="installment-detail-item">
                                    <span>手续费</span>
                                    <span>¥${formatAmount(installmentInfo.monthlyFee)}</span>
                                </div>
                                ${dueDate ? `
                                    <div class="installment-detail-item">
                                        <span>还款日</span>
                                        <span>${formatDate(dueDate)}</span>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                    
                    detailHTML += `
                            </div>
                        </div>
                    `;
                }
                
                // 显示分期子账单信息
                if (installmentSubBills.length > 0) {
                    const totalInstallmentAmount = installmentSubBills.reduce((sum, bill) => sum + (bill.amountDue || bill.totalAmount || 0), 0);
                    
                    detailHTML += `
                        <div class="installment-record">
                            <h4 style="display: flex; align-items: center; justify-content: space-between;">
                                <span style="display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-calendar-check"></i> 分期账单 (${installmentSubBills.length}笔)
                                    <span class="amount-label-box">¥${formatAmount(totalInstallmentAmount)}</span>
                                </span>
                                <button class="section-toggle-btn" id="toggle-installment-bills">
                                    <i class="fas fa-chevron-down"></i> 显示
                                </button>
                            </h4>
                            <div class="repayment-priority-note" id="installment-bills-note">
                                <i class="fas fa-info-circle"></i> 还款时优先偿还分期账单（按分期时间从早到晚）
                            </div>
                            <div id="installment-bills-detail" style="display: none; margin-top: 15px;">
                    `;
                    
                    // 按分期时间排序（从早到晚）
                    installmentSubBills.sort((a, b) => {
                        if (a.installmentPhase && b.installmentPhase) {
                            return a.installmentPhase - b.installmentPhase;
                        }
                        return new Date(a.dueDate) - new Date(b.dueDate);
                    });
                    
                    installmentSubBills.forEach(bill => {
                        const isPaid = bill.isPaid || (bill.amountDue || bill.totalAmount) <= 0;
                        const amount = bill.amountDue || bill.totalAmount || 0;
                        
                        // 查找原账单信息
                        let originalBillInfo = '';
                        if (bill.originalBillId) {
                            const originalBill = state.bills.find(b => b.id === bill.originalBillId);
                            if (originalBill) {
                                originalBillInfo = `(原账单: ${originalBill.year}年${originalBill.month}月)`;
                            }
                        }
                        
                        detailHTML += `
                            <div class="repayment-item installment">
                                <div class="repayment-item-label">
                                    分期第${bill.installmentPhase}期 ${originalBillInfo}
                                    ${isPaid ? '<span style="color: #27ae60; margin-left: 8px;">✓ 已还</span>' : ''}
                                </div>
                                <div class="repayment-item-amount">¥${formatAmount(amount)}</div>
                            </div>
                        `;
                    });
                    
                    detailHTML += `
                            </div>
                        </div>
                    `;
                }
                
                // 显示主账单信息 - 修复：正确显示分期金额
                if (mainBill && (mainBill.amountDue || mainBill.totalAmount) > 0) {
                    const mainBillAmount = mainBill.amountDue || mainBill.totalAmount || 0;
                    let installmentAmountLabel = '';
                    
                    // 修复：如果主账单已分期，显示已分期金额
                    if (mainBill.isInstallment && mainBill.installmentInfo) {
                        const installmentAmount = mainBill.installmentInfo.totalAmount || 0;
                        installmentAmountLabel = `<span class="amount-label-box">已分期¥${formatAmount(installmentAmount)}</span>`;
                    }
                    
                    detailHTML += `
                        <div style="margin-top: 20px;">
                            <h4 style="margin-bottom: 10px; color: var(--primary-color); display: flex; align-items: center; gap: 10px;">
                                <span>本月新消费账单</span>
                                ${installmentAmountLabel}
                            </h4>
                            <div class="repayment-item new-consumption">
                                <div class="repayment-item-label">本月新消费</div>
                                <div class="repayment-item-amount">¥${formatAmount(mainBillAmount)}</div>
                            </div>
                        </div>
                    `;
                }
                
                // 修复：显示交易明细 - 添加免息期和额外年费率，按时间排序
                if (mainBill && mainBill.transactions && mainBill.transactions.length > 0) {
                    // 获取该账单的所有交易
                    const monthTransactions = state.transactions.filter(transaction => 
                        mainBill.transactions.includes(transaction.id)
                    );
                    
                    if (monthTransactions.length > 0) {
                        const totalTransactionAmount = monthTransactions.reduce((sum, trans) => sum + (trans.amount || 0), 0);
                        
                        detailHTML += `
                            <div style="margin-top: 20px;">
                                <h4 style="margin-bottom: 10px; color: var(--primary-color); display: flex; align-items: center; justify-content: space-between;">
                                    <span style="display: flex; align-items: center; gap: 8px;">
                                        交易明细 (${monthTransactions.length}笔)
                                        <span class="amount-label-box">¥${formatAmount(totalTransactionAmount)}</span>
                                    </span>
                                    <button class="section-toggle-btn" id="toggle-transactions">
                                        <i class="fas fa-chevron-down"></i> 显示
                                    </button>
                                </h4>
                                <div id="transactions-detail" style="display: none;">
                                    <div class="bill-transaction-list">
                        `;
                        
                        // 按日期倒序排序，同一天按创建时间倒序（最新在前）- 与交易管理页面一致
                        monthTransactions.sort((a, b) => {
                            // 先按日期倒序
                            const dateDiff = new Date(b.date) - new Date(a.date);
                            if (dateDiff !== 0) return dateDiff;
                            
                            // 同一天按创建时间倒序
                            return new Date(b.createdAt) - new Date(a.createdAt);
                        });
                        
                        monthTransactions.forEach(transaction => {
                            // 计算免息期和额外费用年化率
                            let interestFreeDays = 0;
                            let extraAnnualizedRate = '0.00%';
                            
                            if (mainBill) {
                                interestFreeDays = calculateInterestFreeDays(transaction.date, mainBill.dueDate);
                                extraAnnualizedRate = calculateExtraAnnualizedRate(transaction.extraTotalFee || 0, transaction.amount, transaction.date, mainBill.dueDate) + '%';
                            }
                            
                            detailHTML += `
                                <div class="bill-transaction-item">
                                    <div class="bill-transaction-date">${formatDate(transaction.date)}</div>
                                    <div class="bill-transaction-description">
                                        ${transaction.description || ''}
                                        <div style="display: flex; gap: 10px; margin-top: 4px; font-size: 11px; color: #7f8c8d;">
                                            <span>免息期: ${interestFreeDays}天</span>
                                            <span>额外年费率: ${extraAnnualizedRate}</span>
                                        </div>
                                    </div>
                                    <div class="bill-transaction-amount">¥${formatAmount(transaction.amount)}</div>
                                </div>
                            `;
                        });
                        
                        detailHTML += `
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                } else if (mainBill) {
                    // 如果没有交易明细，但账单存在，显示提示
                    detailHTML += `
                        <div style="margin-top: 20px;">
                            <h4 style="margin-bottom: 10px; color: var(--primary-color); display: flex; align-items: center; justify-content: space-between;">
                                <span style="display: flex; align-items: center; gap: 8px;">
                                    交易明细
                                </span>
                            </h4>
                            <div class="bill-detail-info" style="padding: 12px;">
                                <p><i class="fas fa-info-circle"></i> 该账单暂无交易明细记录</p>
                            </div>
                        </div>
                    `;
                }
            }
            
            document.getElementById('bill-detail-content').innerHTML = detailHTML;
            showModal('bill-detail-modal');
            
            // 绑定原账单分期详情展开/收起事件
            setTimeout(() => {
                const toggleBtn = document.getElementById('toggle-original-installment-detail');
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', function() {
                        const detailContent = document.getElementById('original-installment-detail-content');
                        const icon = this.querySelector('i');
                        
                        if (detailContent.classList.contains('active')) {
                            detailContent.classList.remove('active');
                            icon.className = 'fas fa-chevron-down';
                            this.innerHTML = '<i class="fas fa-chevron-down"></i> 显示分期明细';
                        } else {
                            detailContent.classList.add('active');
                            icon.className = 'fas fa-chevron-up';
                            this.innerHTML = '<i class="fas fa-chevron-up"></i> 隐藏分期明细';
                        }
                    });
                }
                
                // 绑定分期账单展开/收起事件
                const toggleInstallmentBtn = document.getElementById('toggle-installment-bills');
                if (toggleInstallmentBtn) {
                    toggleInstallmentBtn.addEventListener('click', function() {
                        const detailContent = document.getElementById('installment-bills-detail');
                        const noteContent = document.getElementById('installment-bills-note');
                        const icon = this.querySelector('i');
                        
                        if (detailContent.style.display === 'none') {
                            detailContent.style.display = 'block';
                            noteContent.style.display = 'block';
                            icon.className = 'fas fa-chevron-up';
                            this.innerHTML = '<i class="fas fa-chevron-up"></i> 隐藏';
                        } else {
                            detailContent.style.display = 'none';
                            noteContent.style.display = 'none';
                            icon.className = 'fas fa-chevron-down';
                            this.innerHTML = '<i class="fas fa-chevron-down"></i> 显示';
                        }
                    });
                }
                
                // 绑定交易明细展开/收起事件
                const toggleTransactionsBtn = document.getElementById('toggle-transactions');
                if (toggleTransactionsBtn) {
                    toggleTransactionsBtn.addEventListener('click', function() {
                        const detailContent = document.getElementById('transactions-detail');
                        const icon = this.querySelector('i');
                        
                        if (detailContent.style.display === 'none') {
                            detailContent.style.display = 'block';
                            icon.className = 'fas fa-chevron-up';
                            this.innerHTML = '<i class="fas fa-chevron-up"></i> 隐藏';
                        } else {
                            detailContent.style.display = 'none';
                            icon.className = 'fas fa-chevron-down';
                            this.innerHTML = '<i class="fas fa-chevron-down"></i> 显示';
                        }
                    });
                }
            }, 100);
        }
        
        // 隐藏账单详情模态框
        function hideBillDetailModal() {
            hideModal('bill-detail-modal');
        }
        
        // 显示添加交易模态框（为特定卡片） - 账单管理页面使用
        function showAddTransactionModalForCard(cardId) {
            const card = state.cards.find(c => c.id === cardId);
            if (!card) return;
            
            // 设置当前要添加交易的卡片ID
            currentOperation.cardIdForTransactionAdd = cardId;
            
            // 重置表单
            document.getElementById('add-transaction-form').reset();
            
            // 设置默认日期
            document.getElementById('transaction-date').valueAsDate = new Date();
            
            // 设置卡片选择
            updateTransactionCardOptions();
            document.getElementById('transaction-card').value = cardId;
            
            // 设置额外费用
            document.getElementById('transaction-extra-rate').value = formatPercent(state.extraFeeSettings.rate * 100);
            document.getElementById('transaction-extra-fixed').value = state.extraFeeSettings.fixed;
            
            calculateExtraFee();
            
            // 隐藏额外费用选项
            document.getElementById('extra-fee-options').classList.remove('active');
            document.getElementById('toggle-extra-fee').innerHTML = '<i class="fas fa-calculator"></i> 显示额外费用设置';
            
            showModal('add-transaction-modal');
        }
    </script>
    
    <!-- ================ JavaScript模块：还款功能 ================ -->
    <script>
        // 显示合并还款模态框
        function showConsolidatedRepaymentModal(cardId, year, month) {
            const card = state.cards.find(c => c.id === cardId);
            if (!card) {
                showToast('信用卡不存在', 'error');
                return;
            }
            
            // 获取该月该卡的所有账单
            const cardBills = state.bills.filter(bill => 
                bill.cardId === cardId && 
                bill.year == year && 
                bill.month === month
            );
            
            // 分离主账单和分期子账单
            const mainBill = cardBills.find(bill => !bill.installmentPhase);
            const installmentSubBills = cardBills.filter(bill => bill.installmentPhase);
            
            // 按分期时间排序（从早到晚，优先还最早的分期）
            installmentSubBills.sort((a, b) => {
                if (a.installmentPhase && b.installmentPhase) {
                    return a.installmentPhase - b.installmentPhase;
                }
                return new Date(a.dueDate) - new Date(b.dueDate);
            });
            
            // 计算总应还金额
            let totalDueAmount = 0;
            const unpaidInstallmentBills = [];
            
            installmentSubBills.forEach(bill => {
                if (!bill.isPaid && (bill.amountDue || bill.totalAmount) > 0) {
                    const amount = bill.amountDue || bill.totalAmount || 0;
                    totalDueAmount += amount;
                    unpaidInstallmentBills.push(bill);
                }
            });
            
            if (mainBill && !mainBill.isPaid && (mainBill.amountDue || mainBill.totalAmount) > 0) {
                totalDueAmount += mainBill.amountDue || mainBill.totalAmount || 0;
            }
            
            if (totalDueAmount <= 0) {
                showToast('没有需要还款的账单', 'info');
                return;
            }
            
            // 标题包含账单日徽章
            const titleHTML = `
                ${card.bank} (${formatCardNumber(card.number)}) - 合并还款
                <span class="bank-bill-day-badge" style="margin-left: 10px; font-size: 12px;">
                    <i class="fas fa-calendar-day"></i> 账单${card.billDay || 1}日
                </span>
            `;
            document.getElementById('repayment-modal-title').innerHTML = titleHTML;
            
            // 生成还款明细显示
            let repaymentDetailHTML = '';
            
            if (unpaidInstallmentBills.length > 0) {
                repaymentDetailHTML += `
                    <div class="repayment-detail">
                        <h4 style="margin-bottom: 10px;">还款明细 (优先顺序)</h4>
                        <div class="repayment-priority-note">
                            <i class="fas fa-exclamation-circle"></i> 还款金额将优先用于偿还分期账单（按分期时间从早到晚），剩余金额再还新消费账单
                        </div>
                `;
                
                unpaidInstallmentBills.forEach((bill, index) => {
                    const amount = bill.amountDue || bill.totalAmount || 0;
                    repaymentDetailHTML += `
                        <div class="repayment-item installment">
                            <div class="repayment-item-label">
                                ${index + 1}. 分期第${bill.installmentPhase}期
                            </div>
                            <div class="repayment-item-amount">¥${formatAmount(amount)}</div>
                        </div>
                    `;
                });
                
                repaymentDetailHTML += `</div>`;
            }
            
            if (mainBill && !mainBill.isPaid && (mainBill.amountDue || mainBill.totalAmount) > 0) {
                const mainBillAmount = mainBill.amountDue || mainBill.totalAmount || 0;
                repaymentDetailHTML += `
                    <div style="margin-top: 15px;">
                        <div class="repayment-item new-consumption">
                            <div class="repayment-item-label">
                                ${unpaidInstallmentBills.length + 1}. 本月新消费账单
                            </div>
                            <div class="repayment-item-amount">¥${formatAmount(mainBillAmount)}</div>
                        </div>
                    </div>
                `;
            }
            
            let modalHTML = `
                <div class="bill-detail-info">
                    <div class="bill-detail-summary">
                        <div class="bill-detail-item">
                            <div class="bill-detail-item-label">总应还金额</div>
                            <div class="bill-detail-item-value amount">¥${formatAmount(totalDueAmount)}</div>
                        </div>
                        
                        <div class="bill-detail-item">
                            <div class="bill-detail-item-label">还款日</div>
                            <div class="bill-detail-item-value">${mainBill ? formatDate(mainBill.dueDate) : 'N/A'}</div>
                        </div>
                    </div>
                </div>
                
                ${repaymentDetailHTML}
                
                <div class="form-group">
                    <label for="repayment-amount">还款金额（元）*</label>
                    <input type="number" id="repayment-amount" min="0" step="0.01" max="${totalDueAmount}" value="${formatAmountForInput(totalDueAmount)}" required>
                    <div class="amount-input-hint">最大可还金额: ¥${formatAmount(totalDueAmount)}</div>
                </div>
                
                <div id="repayment-preview" style="margin-top: 15px; display: none;">
                    <h5>还款预览:</h5>
                    <div id="repayment-preview-content"></div>
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-success" onclick="submitConsolidatedRepayment('${cardId}', ${year}, ${month})">
                        <i class="fas fa-check"></i> 确认还款
                    </button>
                    <button class="btn btn-danger" onclick="hideRepaymentModal()">
                        取消
                    </button>
                </div>
            `;
            
            document.getElementById('repayment-modal-content').innerHTML = modalHTML;
            
            // 绑定还款金额输入事件，实时显示还款预览
            document.getElementById('repayment-amount').addEventListener('input', function() {
                updateRepaymentPreview(cardId, year, month);
            });
            
            // 初始显示还款预览
            updateRepaymentPreview(cardId, year, month);
            
            showModal('repayment-modal');
        }
        
        // 更新还款预览
        function updateRepaymentPreview(cardId, year, month) {
            const repaymentAmount = parseFloat(document.getElementById('repayment-amount').value) || 0;
            const previewElement = document.getElementById('repayment-preview');
            const previewContent = document.getElementById('repayment-preview-content');
            
            if (repaymentAmount <= 0) {
                previewElement.style.display = 'none';
                return;
            }
            
            // 获取账单信息
            const cardBills = state.bills.filter(bill => 
                bill.cardId === cardId && 
                bill.year == year && 
                bill.month === month
            );
            
            const mainBill = cardBills.find(bill => !bill.installmentPhase);
            const installmentSubBills = cardBills.filter(bill => bill.installmentPhase);
            
            // 按分期时间排序（从早到晚）
            installmentSubBills.sort((a, b) => {
                if (a.installmentPhase && b.installmentPhase) {
                    return a.installmentPhase - b.installmentPhase;
                }
                return new Date(a.dueDate) - new Date(b.dueDate);
            });
            
            // 计算还款分配
            let remainingAmount = repaymentAmount;
            let previewHTML = '<div style="display: flex; flex-direction: column; gap: 5px;">';
            
            // 先还分期账单
            installmentSubBills.forEach(bill => {
                if (!bill.isPaid && (bill.amountDue || bill.totalAmount) > 0 && remainingAmount > 0) {
                    const billAmount = bill.amountDue || bill.totalAmount || 0;
                    const amountToPay = Math.min(billAmount, remainingAmount);
                    
                    if (amountToPay > 0) {
                        previewHTML += `
                            <div style="display: flex; justify-content: space-between; font-size: 14px;">
                                <span>分期第${bill.installmentPhase}期:</span>
                                <span>¥${formatAmount(amountToPay)}</span>
                        </div>
                        `;
                        remainingAmount -= amountToPay;
                    }
                }
            });
            
            // 再还新消费账单
            if (mainBill && remainingAmount > 0 && !mainBill.isPaid && (mainBill.amountDue || mainBill.totalAmount) > 0) {
                const mainBillAmount = mainBill.amountDue || mainBill.totalAmount || 0;
                const amountToPay = Math.min(mainBillAmount, remainingAmount);
                
                if (amountToPay > 0) {
                    previewHTML += `
                        <div style="display: flex; justify-content: space-between; font-size: 14px;">
                            <span>新消费账单:</span>
                            <span>¥${formatAmount(amountToPay)}</span>
                        </div>
                    `;
                    remainingAmount -= amountToPay;
                }
            }
            
            // 如果有剩余金额（还款金额超过总应还金额）
            if (remainingAmount > 0) {
                previewHTML += `
                    <div style="display: flex; justify-content: space-between; font-size: 14px; color: #7f8c8d;">
                        <span>超出部分:</span>
                        <span>¥${formatAmount(remainingAmount)}</span>
                    </div>
                `;
            }
            
            previewHTML += '</div>';
            previewContent.innerHTML = previewHTML;
            previewElement.style.display = 'block';
        }
        
        // 提交合并还款
        function submitConsolidatedRepayment(cardId, year, month) {
            const repaymentAmount = parseFloat(document.getElementById('repayment-amount').value);
            
            if (isNaN(repaymentAmount) || repaymentAmount <= 0) {
                showToast('请输入有效的还款金额', 'error');
                return;
            }
            
            const card = state.cards.find(c => c.id === cardId);
            if (!card) {
                showToast('信用卡不存在', 'error');
                return;
            }
            
            // 获取账单信息
            const cardBills = state.bills.filter(bill => 
                bill.cardId === cardId && 
                bill.year == year && 
                bill.month === month
            );
            
            const mainBill = cardBills.find(bill => !bill.installmentPhase);
            const installmentSubBills = cardBills.filter(bill => bill.installmentPhase);
            
            // 按分期时间排序（从早到晚）
            installmentSubBills.sort((a, b) => {
                if (a.installmentPhase && b.installmentPhase) {
                    return a.installmentPhase - b.installmentPhase;
                }
                return new Date(a.dueDate) - new Date(b.dueDate);
            });
            
            // 记录还款前的账单状态（用于撤销）
            const billsBeforeRepayment = cardBills
                .filter(bill => !bill.isPaid && (bill.amountDue || bill.totalAmount) > 0)
                .map(bill => ({...bill})); // 深拷贝账单状态
            
            // 记录还款前的卡片已用额度（用于撤销）
            const cardIndex = state.cards.findIndex(c => c.id === cardId);
            const cardUsedBefore = cardIndex !== -1 ? state.cards[cardIndex].used : '0';
            
            // 执行还款
            let remainingAmount = repaymentAmount;
            let repaidBills = [];
            
            // 1. 先还分期账单（按分期时间从早到晚）
            for (let i = 0; i < installmentSubBills.length; i++) {
                const bill = installmentSubBills[i];
                
                if (!bill.isPaid && (bill.amountDue || bill.totalAmount) > 0 && remainingAmount > 0) {
                    const billAmount = bill.amountDue || bill.totalAmount || 0;
                    const amountToPay = Math.min(billAmount, remainingAmount);
                    
                    if (amountToPay > 0) {
                        // 更新账单
                        bill.paidAmount = (bill.paidAmount || 0) + amountToPay;
                        bill.amountDue = Math.max(0, billAmount - amountToPay);
                        
                        if (bill.amountDue <= 0) {
                            bill.isPaid = true;
                            bill.paidDate = new Date().toISOString().split('T')[0];
                        }
                        
                        remainingAmount -= amountToPay;
                        repaidBills.push({
                            billId: bill.id,
                            amount: amountToPay,
                            type: '分期'
                        });
                    }
                }
            }
            
            // 2. 再还新消费账单
            if (mainBill && remainingAmount > 0 && !mainBill.isPaid && (mainBill.amountDue || mainBill.totalAmount) > 0) {
                const mainBillAmount = mainBill.amountDue || mainBill.totalAmount || 0;
                const amountToPay = Math.min(mainBillAmount, remainingAmount);
                
                if (amountToPay > 0) {
                    // 更新账单
                    mainBill.paidAmount = (mainBill.paidAmount || 0) + amountToPay;
                    mainBill.amountDue = Math.max(0, mainBillAmount - amountToPay);
                    
                    if (mainBill.amountDue <= 0) {
                        mainBill.isPaid = true;
                        mainBill.paidDate = new Date().toISOString().split('T')[0];
                    }
                    
                    remainingAmount -= amountToPay;
                    repaidBills.push({
                        billId: mainBill.id,
                        amount: amountToPay,
                        type: '新消费'
                    });
                }
            }
            
            // 3. 更新卡片已使用额度
            const totalRepaid = repaymentAmount - remainingAmount;
            if (totalRepaid > 0) {
                if (cardIndex !== -1) {
                    const newUsed = Math.max(0, parseFloat(state.cards[cardIndex].used) - totalRepaid);
                    state.cards[cardIndex].used = newUsed.toFixed(2);
                    state.cards[cardIndex].remaining = (parseFloat(state.cards[cardIndex].limit) - parseFloat(state.cards[cardIndex].used)).toFixed(2);
                }
            }
            
            // 4. 记录还款历史
            let repaymentRecord;
            if (repaidBills.length > 0) {
                repaymentRecord = {
                    id: 'repay_' + Date.now(),
                    cardId: cardId,
                    year: year,
                    month: month,
                    amount: totalRepaid,
                    type: 'consolidated',
                    bills: repaidBills,
                    date: new Date().toISOString().split('T')[0],
                    remainingAmount: remainingAmount > 0 ? remainingAmount : 0
                };
                
                state.repaymentHistory.push(repaymentRecord);
            }
            
            // 记录操作历史（用于撤销）
            if (totalRepaid > 0) {
                recordOperation({
                    type: 'repayment',
                    timestamp: new Date().toISOString(),
                    data: {
                        repaymentRecord,
                        billsBeforeRepayment,
                        cardUsedBefore
                    }
                });
            }
            
            // 保存数据
            saveAllData();
            
            // 隐藏模态框
            hideRepaymentModal();
            
            // 重新渲染界面
            renderMonthGrid();
            renderMonthBillsCards();
            
            // 如果当前在仪表盘页面，也更新仪表盘界面
            if (shouldRenderDashboard) {
                renderDashboard();
            }
            
            // 显示成功消息
            if (totalRepaid > 0) {
                showToast(`还款成功！已还款¥${formatAmount(totalRepaid)}${remainingAmount > 0 ? `，其中¥${formatAmount(remainingAmount)}超出应还金额` : ''}`);
            } else {
                showToast('还款失败，请检查还款金额', 'error');
            }
        }
        
        // 隐藏还款模态框
        function hideRepaymentModal() {
            hideModal('repayment-modal');
        }
    </script>
    
    <!-- ================ JavaScript模块：分期功能 ================ -->
    <script>
        // 计算分期子账单的关联月份
        function calculateInstallmentMonth(originalYear, originalMonth, phase) {
            let year = originalYear;
            let month = originalMonth;
            
            // 核心优化：从原账单的下一个月开始计算
            month += phase;
            
            // 处理月份超过12的情况（跨年）
            while (month > 12) {
                month -= 12;
                year += 1;
            }
            
            return { year, month };
        }
        
        // 显示分期模态框
        function showInstallmentModal(cardId, year, month) {
            const card = state.cards.find(c => c.id === cardId);
            if (!card) return;
            
            // 获取该月该卡的主账单
            const mainBill = state.bills.find(bill => 
                bill.cardId === cardId && 
                bill.year == year && 
                bill.month === month &&
                !bill.installmentPhase
            );
            
            if (!mainBill) {
                showToast('本月无账单可分期', 'warning');
                return;
            }
            
            const totalAmount = mainBill.amountDue || mainBill.totalAmount || 0;
            
            if (totalAmount <= 0) {
                showToast('无可分期的账单金额', 'warning');
                return;
            }
            
            // 检查是否已经分期
            if (mainBill.isInstallment) {
                showToast('该账单已经分期，如需再次分期请先还清或取消原有分期', 'warning');
                return;
            }
            
            // 保存分期信息到当前操作状态
            currentOperation.installmentCardId = cardId;
            currentOperation.installmentYear = year;
            currentOperation.installmentMonth = month;
            
            let modalHTML = `
                <div class="bill-detail-info">
                    <div class="bill-detail-summary">
                        <div class="bill-detail-item">
                            <div class="bill-detail-item-label">可分期金额</div>
                            <div class="bill-detail-item-value amount">¥${formatAmount(totalAmount)}</div>
                        </div>
                        
                        <div class="bill-detail-item">
                            <div class="bill-detail-item-label">原账单月份</div>
                            <div class="bill-detail-item-value">${year}年${month}月</div>
                        </div>
                        
                        <div class="bill-detail-item">
                            <div class="bill-detail-item-label">分期状态</div>
                            <div class="bill-detail-item-value">未分期</div>
                        </div>
                    </div>
                </div>
                
                <h4><i class="fas fa-calculator"></i> 分期设置</h4>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="installment-period-modal">分期期数</label>
                        <select id="installment-period-modal" class="form-control">
                            <option value="3">3期</option>
                            <option value="6" selected>6期</option>
                            <option value="12">12期</option>
                            <option value="24">24期</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="installment-rate-modal">手续费率（每期）%</label>
                        <input type="number" id="installment-rate-modal" class="form-control" 
                               min="0" step="0.01" value="0.6" required>
                        <div class="amount-input-hint">自定义手续费率，默认0.6%</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="installment-amount-modal">分期金额 *</label>
                    <input type="number" id="installment-amount-modal" class="form-control" 
                           min="0" step="0.01" value="${formatAmountForInput(totalAmount)}" max="${totalAmount}" required>
                    <div class="amount-input-hint">默认使用全部可分期金额，可输入部分金额分期</div>
                </div>
                
                <div id="installment-calculator-result" style="margin-top: 20px;">
                    <!-- 分期计算结果会动态生成 -->
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-success" onclick="submitInstallment()">
                        <i class="fas fa-check"></i> 确认分期
                    </button>
                    <button class="btn btn-danger" onclick="hideInstallmentModal()">
                        取消
                    </button>
                </div>
            `;
            
            document.getElementById('installment-modal-content').innerHTML = modalHTML;
            
            // 绑定事件，实时计算分期结果
            document.getElementById('installment-period-modal').addEventListener('change', calculateInstallmentResult);
            document.getElementById('installment-rate-modal').addEventListener('input', calculateInstallmentResult);
            document.getElementById('installment-amount-modal').addEventListener('input', calculateInstallmentResult);
            
            // 初始计算
            calculateInstallmentResult();
            
            showModal('installment-modal');
        }
        
        // 计算分期结果
        function calculateInstallmentResult() {
            const period = parseInt(document.getElementById('installment-period-modal').value) || 6;
            const feeRate = parseFloat(document.getElementById('installment-rate-modal').value) || 0.6;
            const amount = parseFloat(document.getElementById('installment-amount-modal').value) || 0;
            
            if (amount <= 0) return;
            
            // 每期手续费
            const monthlyFee = amount * (feeRate / 100);
            // 每期本金
            const monthlyPrincipal = amount / period;
            // 每期还款总额
            const monthlyPayment = monthlyPrincipal + monthlyFee;
            // 总手续费
            const totalFee = monthlyFee * period;
            // 总还款额
            const totalPayment = amount + totalFee;
            
            // 计算年化率
            const totalFeeRate = feeRate * period; // 总手续费率
            const nominalAPR = feeRate * 12; // 名义年化率 = 月费率 × 12
            const realAPR = feeRate * 24 * period / (period + 1); // 实际年化率 = 月费率 × 24 × n / (n+1)
            
            let resultHTML = `
                <div class="installment-plan">
                    <h4>${period}期分期计划</h4>
                    <div style="background-color: #f8f9fa; padding: 15px; border-radius: var(--border-radius); margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>分期总额:</span>
                            <span style="font-weight: 600; color: var(--primary-color);">¥${formatAmount(amount)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>每期手续费率:</span>
                            <span style="font-weight: 600; color: var(--primary-color);">${formatPercent(feeRate)}%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>每期还款金额:</span>
                            <span style="font-weight: 600; color: var(--accent-color);">¥${formatAmount(monthlyPayment)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>总手续费:</span>
                            <span style="font-weight: 600; color: var(--accent-color);">¥${formatAmount(totalFee)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>总还款额:</span>
                            <span style="font-weight: 600; color: var(--accent-color);">¥${formatAmount(totalPayment)}</span>
                        </div>
                    </div>
                    
                    <div class="installment-apr">
                        <div class="installment-apr-header">
                            <span><i class="fas fa-chart-line"></i> 分期成本分析</span>
                        </div>
                        <div class="installment-apr-detail">
                            <div class="installment-apr-item">
                                <div class="installment-apr-label">总手续费率</div>
                                <div class="installment-apr-value">${formatPercent(totalFeeRate)}%</div>
                            </div>
                            <div class="installment-apr-item">
                                <div class="installment-apr-label">名义年化率</div>
                                <div class="installment-apr-value">${formatPercent(nominalAPR)}%</div>
                            </div>
                            <div class="installment-apr-item">
                                <div class="installment-apr-label">实际年化率</div>
                                <div class="installment-apr-value highlight">${formatPercent(realAPR)}%</div>
                            </div>
                            <div class="installment-apr-item">
                                <div class="installment-apr-label">成本倍数</div>
                                <div class="installment-apr-value">${formatNumber(realAPR / nominalAPR, 2)}倍</div>
                            </div>
                        </div>
                        <div class="installment-apr-note">
                            <i class="fas fa-info-circle"></i> <strong>分析说明：</strong>
                            <ul style="margin: 5px 0 0 15px; font-size: 12px;">
                                <li><strong>总手续费率 ${formatPercent(totalFeeRate)}%</strong>: ${period}期 × 每期${formatPercent(feeRate)}%</li>
                                <li><strong>名义年化率 ${formatPercent(nominalAPR)}%</strong>: 月费率${formatPercent(feeRate)}% × 12个月</li>
                                <li><strong>实际年化率 ${formatPercent(realAPR)}%</strong>: 考虑资金占用时间的真实成本，计算公式：月费率 × 24 × ${period} ÷ (${period}+1)</li>
                                <li><strong>成本倍数 ${formatNumber(realAPR / nominalAPR, 2)}倍</strong>: 实际成本是名义成本的${formatNumber(realAPR / nominalAPR, 2)}倍</li>
                            </ul>
                        </div>
                    </div>
                    
                    <button class="installment-detail-toggle" id="toggle-installment-detail-modal" style="margin-top: 15px;">
                        <i class="fas fa-chevron-down"></i> 显示分期明细
                    </button>
                    
                    <div class="installment-detail-content" id="installment-detail-content-modal" style="margin-top: 15px;">
                        <h5 style="margin-bottom: 10px; color: var(--primary-color);">分期明细（共${period}期）:</h5>
            `;
            
            // 生成分期明细
            const { installmentCardId, installmentYear, installmentMonth } = currentOperation;
            
            for (let i = 1; i <= period; i++) {
                // 使用优化后的月份计算函数
                const installmentMonthCalc = calculateInstallmentMonth(installmentYear, installmentMonth, i);
                const year = installmentMonthCalc.year;
                const month = installmentMonthCalc.month;
                
                resultHTML += `
                    <div class="installment-phase" style="margin-bottom: 10px;">
                        <div class="installment-phase-header">
                            <span>第${i}期 (${year}年${month}月)</span>
                            <span>¥${formatAmount(monthlyPayment)}</span>
                        </div>
                        <div class="installment-detail-item">
                            <span>本金</span>
                            <span>¥${formatAmount(monthlyPrincipal)}</span>
                        </div>
                        <div class="installment-detail-item">
                            <span>手续费</span>
                            <span>¥${formatAmount(monthlyFee)}</span>
                        </div>
                        <div class="installment-detail-item">
                            <span>账单月份</span>
                            <span>${year}年${month}月</span>
                        </div>
                    </div>
                `;
            }
            
            resultHTML += `
                    </div>
                </div>
            `;
            
            document.getElementById('installment-calculator-result').innerHTML = resultHTML;
            
            // 绑定展开/收起事件
            const toggleBtn = document.getElementById('toggle-installment-detail-modal');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', function() {
                    const detailContent = document.getElementById('installment-detail-content-modal');
                    const icon = this.querySelector('i');
                    
                    if (detailContent.classList.contains('active')) {
                        detailContent.classList.remove('active');
                        icon.className = 'fas fa-chevron-down';
                        this.innerHTML = '<i class="fas fa-chevron-down"></i> 显示分期明细';
                    } else {
                        detailContent.classList.add('active');
                        icon.className = 'fas fa-chevron-up';
                        this.innerHTML = '<i class="fas fa-chevron-up"></i> 隐藏分期明细';
                    }
                });
            }
        }
        
        // 提交分期 - 修改6：分期手续费也占用额度
        function submitInstallment() {
            const { installmentCardId, installmentYear, installmentMonth } = currentOperation;
            
            if (!installmentCardId || !installmentYear || !installmentMonth) {
                showToast('分期信息不完整', 'error');
                return;
            }
            
            const period = parseInt(document.getElementById('installment-period-modal').value);
            const feeRate = parseFloat(document.getElementById('installment-rate-modal').value) / 100;
            const installmentAmount = parseFloat(document.getElementById('installment-amount-modal').value);
            
            if (period <= 0 || isNaN(period)) {
                showToast('请选择正确的分期期数', 'error');
                return;
            }
            
            if (isNaN(feeRate) || feeRate < 0) {
                showToast('请输入正确的手续费率', 'error');
                return;
            }
            
            if (isNaN(installmentAmount) || installmentAmount <= 0) {
                showToast('请输入正确的分期金额', 'error');
                return;
            }
            
            // 获取该月该卡的主账单
            const mainBill = state.bills.find(bill => 
                bill.cardId === installmentCardId && 
                bill.year == installmentYear && 
                bill.month === installmentMonth &&
                !bill.installmentPhase
            );
            
            if (!mainBill) {
                showToast('账单不存在', 'error');
                return;
            }
            
            const totalAmount = mainBill.amountDue || mainBill.totalAmount || 0;
            
            if (installmentAmount > totalAmount) {
                showToast('分期金额不能超过账单总额', 'error');
                return;
            }
            
            const card = state.cards.find(c => c.id === installmentCardId);
            if (!card) {
                showToast('信用卡不存在', 'error');
                return;
            }
            
            // 记录分期前的原账单状态（用于撤销）- 使用深拷贝
            const originalBillBefore = JSON.parse(JSON.stringify(mainBill));
            
            // 计算分期计划
            const monthlyFee = installmentAmount * feeRate;
            const monthlyPrincipal = installmentAmount / period;
            const monthlyPayment = monthlyPrincipal + monthlyFee;
            const totalFee = monthlyFee * period;
            const totalPayment = installmentAmount + totalFee;
            
            // 生成分期ID
            const installmentId = 'inst_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // 记录分期前的卡片已用额度（用于撤销）
            const cardIndex = state.cards.findIndex(c => c.id === installmentCardId);
            const cardUsedBefore = cardIndex !== -1 ? state.cards[cardIndex].used : '0';
            
            // 更新主账单
            mainBill.isInstallment = true;
            mainBill.installmentId = installmentId;
            mainBill.installmentInfo = {
                totalAmount: installmentAmount,
                period: period,
                feeRate: feeRate,
                monthlyPayment: monthlyPayment,
                monthlyPrincipal: monthlyPrincipal,
                monthlyFee: monthlyFee,
                totalFee: totalFee,
                totalPayment: totalPayment
            };
            
            // 减少主账单应还金额
            mainBill.amountDue = Math.max(0, totalAmount - installmentAmount);
            if (mainBill.amountDue <= 0) {
                mainBill.isPaid = true;
                mainBill.paidDate = new Date().toISOString().split('T')[0];
            }
            
            // 修改6：分期手续费也占用额度
            // 总占用额度 = 分期本金 + 分期总手续费
            const totalOccupiedAmount = installmentAmount + totalFee;
            
            // 更新卡片已使用额度 - 增加分期手续费占用
            if (cardIndex !== -1) {
                // 注意：分期本金已经占用额度，只需要增加手续费占用
                const currentUsed = parseFloat(state.cards[cardIndex].used);
                state.cards[cardIndex].used = (currentUsed + totalFee).toFixed(2);
                state.cards[cardIndex].remaining = (parseFloat(state.cards[cardIndex].limit) - parseFloat(state.cards[cardIndex].used)).toFixed(2);
            }
            
            // 创建分期子账单（使用优化后的月份计算）
            for (let i = 1; i <= period; i++) {
                // 使用优化后的月份计算函数
                const installmentMonthCalc = calculateInstallmentMonth(installmentYear, installmentMonth, i);
                const billYear = installmentMonthCalc.year;
                const billMonth = installmentMonthCalc.month;
                
                // 计算还款日（使用账单日 + dueDays）
                const billDate = new Date(billYear, billMonth - 1, card.billDay || 1);
                const dueDate = calculateDueDate(billDate, card.dueDays || 20);
                
                // 创建分期子账单
                const phaseBillId = `${mainBill.id}_phase_${i}`;
                const phaseBill = {
                    id: phaseBillId,
                    billId: phaseBillId,
                    cardId: installmentCardId,
                    cardNumber: card.number,
                    bank: card.bank,
                    year: billYear,
                    month: billMonth,
                    billDay: card.billDay || 1,
                    dueDays: card.dueDays || 20, // 修复：使用dueDays字段
                    billDate: billDate.toISOString().split('T')[0],
                    dueDate: dueDate.toISOString().split('T')[0],
                    transactions: mainBill.transactions || [],
                    totalAmount: monthlyPayment,
                    amountDue: monthlyPayment,
                    paidAmount: 0,
                    isPaid: false,
                    isInstallment: true,
                    installmentId: installmentId,
                    installmentPhase: i,
                    originalBillId: mainBill.id,
                    installmentFee: monthlyFee, // 记录分期手续费
                    installmentPrincipal: monthlyPrincipal, // 记录分期本金
                    createdAt: new Date().toISOString()
                };
                
                state.bills.push(phaseBill);
            }
            
            // 记录分期历史
            const installmentRecord = {
                id: installmentId,
                cardId: installmentCardId,
                originalBillId: mainBill.id,
                amount: installmentAmount,
                period: period,
                feeRate: feeRate,
                monthlyPayment: monthlyPayment,
                totalPayment: totalPayment,
                date: new Date().toISOString().split('T')[0],
                phases: period
            };
            
            state.installments.push(installmentRecord);
            
            // 记录操作历史（用于撤销）- 包含手续费占用信息
            recordOperation({
                type: 'installment',
                timestamp: new Date().toISOString(),
                data: {
                    installmentId,
                    originalBillBefore,
                    cardId: installmentCardId,
                    cardUsedBefore,
                    totalFee
                }
            });
            
            saveAllData();
            
            hideInstallmentModal();
            
            // 重置当前操作状态
            currentOperation.installmentCardId = null;
            currentOperation.installmentYear = null;
            currentOperation.installmentMonth = null;
            
            // 重新渲染界面
            renderMonthGrid();
            renderMonthBillsCards();
            
            // 如果当前在仪表盘页面，也更新仪表盘界面
            if (shouldRenderDashboard) {
                renderDashboard();
            }
            
            showToast(`分期成功！${period}期，每期¥${formatAmount(monthlyPayment)}，手续费已占用额度`);
        }
        
        // 隐藏分期模态框
        function hideInstallmentModal() {
            hideModal('installment-modal');
            // 重置当前操作状态
            currentOperation.installmentCardId = null;
            currentOperation.installmentYear = null;
            currentOperation.installmentMonth = null;
        }
    </script>
    
    <!-- ================ JavaScript模块：撤销功能 ================ -->
    <script>
        // 记录操作到撤销历史
        function recordOperation(operation) {
            // 限制历史记录最多保留3条
            if (state.undoHistory.length >= 3) {
                state.undoHistory.shift(); // 移除最旧的操作
            }
            
            state.undoHistory.push(operation);
            saveAllData();
            updateUndoButton();
        }
        
        // 更新撤销按钮状态
        function updateUndoButton() {
            const undoBtn = document.getElementById('undo-btn');
            if (state.undoHistory.length > 0) {
                undoBtn.disabled = false;
                undoBtn.style.backgroundColor = 'var(--warning-color)'; // 启用时为警告色（橙色）
                undoBtn.title = `撤销上一步操作 (${state.undoHistory.length}/3)`;
            } else {
                undoBtn.disabled = true;
                undoBtn.style.backgroundColor = '#95a5a6'; // 禁用时为灰色
                undoBtn.title = '无可撤销的操作';
            }
        }
        
        // 撤销上一步操作
        function undoLastOperation() {
            if (state.undoHistory.length === 0) {
                showToast('没有可撤销的操作', 'info');
                return;
            }
            
            const lastOperation = state.undoHistory.pop();
            
            switch (lastOperation.type) {
                case 'add_transaction':
                    undoAddTransaction(lastOperation);
                    break;
                case 'repayment':
                    undoRepayment(lastOperation);
                    break;
                case 'installment':
                    undoInstallment(lastOperation);
                    break;
                default:
                    console.warn('未知的操作类型:', lastOperation.type);
                    break;
            }
            
            saveAllData();
            
            // 根据当前页面更新界面
            if (state.currentMainTab === 'dashboard') {
                renderDashboard();
            } else if (state.currentMainTab === 'transactions') {
                if (state.currentTransactionTab === 'all') {
                    renderAllTransactions();
                } else if (state.currentTransactionTab === 'current') {
                    renderCurrentBillTransactions();
                } else if (state.currentTransactionTab === 'next') {
                    renderNextBillTransactions();
                }
                updateExtraFeeSummary();
                updatePaginationControls();
            } else if (state.currentMainTab === 'bills') {
                renderMonthGrid();
                renderMonthBillsCards();
            }
            
            updateUndoButton();
            
            showToast(`已撤销${getOperationTypeName(lastOperation.type)}操作`, 'info');
        }
        
        // 获取操作类型的中文名称
        function getOperationTypeName(type) {
            const typeNames = {
                'add_transaction': '添加交易',
                'repayment': '还款',
                'installment': '分期'
            };
            return typeNames[type] || type;
        }
        
        // 撤销添加交易
        function undoAddTransaction(operation) {
            const { transaction, cardUsedBefore } = operation.data;
            
            // 1. 从交易记录中移除该交易
            state.transactions = state.transactions.filter(t => t.id !== transaction.id);
            
            // 2. 恢复卡片的已用额度
            const cardIndex = state.cards.findIndex(c => c.id === transaction.cardId);
            if (cardIndex !== -1) {
                state.cards[cardIndex].used = cardUsedBefore;
                state.cards[cardIndex].remaining = (parseFloat(state.cards[cardIndex].limit) - parseFloat(cardUsedBefore)).toFixed(2);
            }
            
            // 3. 更新相关账单
            updateBillAfterTransactionRemoval(transaction);
            
            console.log(`已撤销交易: ${transaction.id}`);
        }
        
        // 撤销还款
        function undoRepayment(operation) {
            const { repaymentRecord, billsBeforeRepayment, cardUsedBefore } = operation.data;
            
            // 1. 移除还款记录
            state.repaymentHistory = state.repaymentHistory.filter(r => r.id !== repaymentRecord.id);
            
            // 2. 恢复账单状态
            billsBeforeRepayment.forEach(billState => {
                const billIndex = state.bills.findIndex(b => b.id === billState.id);
                if (billIndex !== -1) {
                    // 恢复账单的原始状态
                    Object.assign(state.bills[billIndex], billState);
                }
            });
            
            // 3. 恢复卡片已用额度
            const cardIndex = state.cards.findIndex(c => c.id === repaymentRecord.cardId);
            if (cardIndex !== -1) {
                state.cards[cardIndex].used = cardUsedBefore;
                state.cards[cardIndex].remaining = (parseFloat(state.cards[cardIndex].limit) - parseFloat(cardUsedBefore)).toFixed(2);
            }
            
            console.log(`已撤销还款: ${repaymentRecord.id}`);
        }
        
        // 撤销分期 - 修改7：恢复手续费占用额度
        function undoInstallment(operation) {
            const { installmentId, originalBillBefore, cardId, cardUsedBefore, totalFee } = operation.data;
            
            // 1. 删除分期计划
            state.installments = state.installments.filter(i => i.id !== installmentId);
            
            // 2. 查找原账单（注意：原账单可能已被修改，需要找到正确的账单）
            const originalBillIndex = state.bills.findIndex(b => b.id === originalBillBefore.id);
            if (originalBillIndex !== -1) {
                // 完全用原始账单状态替换当前账单状态（深度恢复）
                state.bills[originalBillIndex] = JSON.parse(JSON.stringify(originalBillBefore));
            } else {
                // 如果原账单不存在，重新创建
                state.bills.push(JSON.parse(JSON.stringify(originalBillBefore)));
            }
            
            // 3. 删除所有分期子账单
            state.bills = state.bills.filter(bill => 
                !bill.installmentId || bill.installmentId !== installmentId
            );
            
            // 修改7：恢复手续费占用的额度
            if (cardId && totalFee) {
                const cardIndex = state.cards.findIndex(c => c.id === cardId);
                if (cardIndex !== -1) {
                    const currentUsed = parseFloat(state.cards[cardIndex].used);
                    state.cards[cardIndex].used = Math.max(0, currentUsed - totalFee).toFixed(2);
                    state.cards[cardIndex].remaining = (parseFloat(state.cards[cardIndex].limit) - parseFloat(state.cards[cardIndex].used)).toFixed(2);
                }
            }
            
            console.log(`已撤销分期: ${installmentId}，原账单已完全恢复，手续费占用已释放`);
        }
        
        // 更新账单（移除交易后）
        function updateBillAfterTransactionRemoval(transaction) {
            // 查找受影响的账单
            const affectedBills = state.bills.filter(bill => 
                bill.transactions && bill.transactions.includes(transaction.id)
            );
            
            affectedBills.forEach(bill => {
                // 从账单的交易列表中移除该交易
                bill.transactions = bill.transactions.filter(t => t !== transaction.id);
                
                // 更新账单金额
                bill.totalAmount = Math.max(0, bill.totalAmount - transaction.amount);
                bill.amountDue = Math.max(0, bill.amountDue - transaction.amount);
                
                // 如果账单金额为0，标记为已还
                if (bill.totalAmount <= 0) {
                    bill.isPaid = true;
                    bill.paidAmount = 0;
                }
                
                // 如果账单没有交易了，可以删除该账单
                if (bill.transactions.length === 0 && bill.totalAmount === 0) {
                    state.bills = state.bills.filter(b => b.id !== bill.id);
                }
            });
        }
    </script>
    
    <!-- ================ JavaScript模块：重置数据功能 ================ -->
    <script>
        // 显示重置数据确认模态框
        function showResetModal() {
            showModal('reset-data-modal');
        }
        
        // 隐藏重置数据确认模态框
        function hideResetModal() {
            hideModal('reset-data-modal');
        }
        
        // 确认重置数据
        function confirmResetData() {
            try {
                localStorage.removeItem('creditCards');
                localStorage.removeItem('creditTransactions');
                localStorage.removeItem('creditBills');
                localStorage.removeItem('creditInstallments');
                localStorage.removeItem('creditRepaymentHistory');
                localStorage.removeItem('creditExtraFeeSettings');
                localStorage.removeItem('creditUndoHistory');
                
                state.cards = [];
                state.transactions = [];
                state.bills = [];
                state.installments = [];
                state.repaymentHistory = [];
                state.extraFeeSettings = {
                    rate: 0.006,
                    fixed: 0
                };
                state.undoHistory = [];
                state.currentRepaymentBill = null;
                state.pagination = {
                    currentPage: 1,
                    pageSize: 20,
                    totalPages: 1,
                    totalTransactions: 0
                };
                
                checkAndCreateDefaultCard();
                
                hideResetModal();
                
                // 重新渲染所有界面
                initTransactions();
                initBillsManagement();
                initDashboard();
                updateUndoButton();
                
                showToast('所有数据已重置，已恢复默认设置', 'info');
            } catch (error) {
                console.error('重置数据失败:', error);
                showToast('重置数据失败，请重试', 'error');
            }
        }
    </script>
    
    <!-- ================ JavaScript模块：Excel备份恢复功能 ================ -->
    <script>
        // 显示进度
        function showProgress(text, pct){
            document.getElementById('progress-text').textContent = text || '';
            document.getElementById('progress-bar').style.width = (pct||0) + '%';
            showModal('progress-modal');
        }
        
        // 隐藏进度
        function hideProgress(){ 
            hideModal('progress-modal');
        }
        
        // 导出Excel
        function exportExcel(){
            try{
                showProgress('收集数据…', 10);
                const wb = XLSX.utils.book_new();

                const sheets = {
                    '交易记录': state.transactions,
                    '账单数据': state.bills,
                    '分期计划': state.installments,
                    '还款历史': state.repaymentHistory,
                    '卡片信息': state.cards,
                    '系统设置': {
                        extraFees: JSON.stringify(state.extraFeeSettings),
                        version: 'backup-v2',
                        exportedAt: new Date().toISOString()
                    }
                };

                let pct = 20;
                Object.keys(sheets).forEach(name=>{
                    const data = Array.isArray(sheets[name]) ? sheets[name] : [sheets[name]];
                    const ws = XLSX.utils.json_to_sheet(data);
                    XLSX.utils.book_append_sheet(wb, ws, name);
                    pct += 10; 
                    showProgress('生成工作表：' + name, pct);
                });

                showProgress('生成文件…', 90);
                const wbout = XLSX.write(wb, {bookType:'xlsx', type:'array'});
                const blob = new Blob([wbout], {type:'application/octet-stream'});

                // 下载文件
                const filename = '信用卡管理备份.xlsx';
                if (navigator.share){
                    const file = new File([blob], filename, {type: blob.type});
                    navigator.share({files:[file], title:filename}).catch(()=>{
                        const a = document.createElement('a');
                        a.href = URL.createObjectURL(blob); 
                        a.download = filename; 
                        a.click();
                        URL.revokeObjectURL(a.href);
                    });
                } else {
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob); 
                        a.download = filename; 
                        a.click();
                    URL.revokeObjectURL(a.href);
                }
                hideProgress();
                showToast('备份完成（Excel）','success');
            }catch(e){
                hideProgress();
                console.error(e);
                showToast('备份失败','error');
            }
        }

        // 恢复Excel
        async function restoreExcel(file){
            try{
                showProgress('读取文件…', 10);
                const data = await file.arrayBuffer();
                const wb = XLSX.read(data, {type:'array'});
                const read = name => wb.Sheets[name] ? XLSX.utils.sheet_to_json(wb.Sheets[name]) : [];

                const tx = read('交易记录');
                const bills = read('账单数据');
                const inst = read('分期计划');
                const repay = read('还款历史');
                const cards = read('卡片信息');
                const settings = read('系统设置');

                showProgress('写入数据…', 60);
                
                // 恢复数据
                state.transactions = tx || [];
                state.bills = bills || [];
                state.installments = inst || [];
                state.repaymentHistory = repay || [];
                state.cards = cards || [];
                
                // 恢复额外费用设置
                if (settings && settings.length > 0 && settings[0].extraFees) {
                    try {
                        state.extraFeeSettings = JSON.parse(settings[0].extraFees);
                    } catch (e) {
                        console.error('恢复额外费用设置失败:', e);
                    }
                }

                // 修复：确保数据结构正确 - 重建账单与交易、分期之间的关系
                ensureBillDataStructure();
                
                // 保存数据
                saveAllData();
                
                // 重新渲染界面
                if (state.currentMainTab === 'dashboard') {
                    renderDashboard();
                } else if (state.currentMainTab === 'transactions') {
                    if (state.currentTransactionTab === 'all') {
                        renderAllTransactions();
                    } else if (state.currentTransactionTab === 'current') {
                        renderCurrentBillTransactions();
                    } else if (state.currentTransactionTab === 'next') {
                        renderNextBillTransactions();
                    }
                    updateExtraFeeSummary();
                    updatePaginationControls();
                } else if (state.currentMainTab === 'bills') {
                    renderMonthGrid(); 
                    renderMonthBillsCards();
                }
                
                updateUndoButton();
                
                hideProgress();
                closeAllModals(); // 关闭所有打开的模态框
                showToast('恢复完成','success');
            }catch(e){
                hideProgress();
                console.error(e);
                showToast('恢复失败','error');
            }
        }
    </script>
    
    <!-- ================ JavaScript模块：全局函数导出 ================ -->
    <script>
        // 使函数在全局可用
        window.showEditTransactionModal = showEditTransactionModal;
        window.showDeleteTransactionModal = showDeleteTransactionModal;
        window.selectMonth = selectMonth;
        window.showAddTransactionModalForCard = showAddTransactionModalForCard;
        window.showBillDetail = showBillDetail;
        window.showConsolidatedRepaymentModal = showConsolidatedRepaymentModal;
        window.showInstallmentModal = showInstallmentModal;
        window.hideInstallmentModal = hideInstallmentModal;
        window.submitInstallment = submitInstallment;
        window.calculateInstallmentMonth = calculateInstallmentMonth;
        window.hideModal = hideModal;
        window.showEditCardModal = showEditCardModal;
        window.showDeleteConfirmModal = showDeleteConfirmModal;
    </script>
</body>
</html>